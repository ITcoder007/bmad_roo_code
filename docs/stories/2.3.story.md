# Story 2.3: 邮件通知服务（日志实现）

## Status
READY

## Story
**As a** 后端开发人员,
**I want** 实现邮件通知服务的日志记录,
**so that** 系统能够记录邮件发送的预警信息.

## Acceptance Criteria
1. 实现邮件预警信息的日志记录功能
2. 记录预警证书的基本信息，包括证书名称、域名和到期日期
3. 记录预警的时间点和预警类型（如30天、15天、7天、1天）
4. 添加日志格式的基本配置功能
5. 编写日志记录的单元测试
6. 验证日志记录的基本功能

## Tasks / Subtasks
- [ ] Task 1: 创建邮件服务接口和实现（AC: 1）
  - [ ] Subtask 1.1: 创建 `service/EmailService.java` 接口，定义邮件发送契约
  - [ ] Subtask 1.2: 创建 `service/impl/EmailServiceImpl.java` 实现类（用于生产环境）
  - [ ] Subtask 1.3: 创建 `infrastructure/external/email/LogEmailServiceImpl.java` 日志实现类（MVP阶段）
  - [ ] Subtask 1.4: 配置 Spring 依赖注入，默认使用日志实现

- [ ] Task 2: 实现邮件预警信息记录（AC: 2, 3）
  - [ ] Subtask 2.1: 在 `LogEmailServiceImpl` 中实现 `sendExpiryAlertEmail()` 方法
  - [ ] Subtask 2.2: 设计邮件预警日志格式，包含证书名称、域名、到期日期、预警类型
  - [ ] Subtask 2.3: 集成 `MonitoringLogService` 记录邮件预警到数据库
  - [ ] Subtask 2.4: 添加邮件发送结果的结构化日志记录

- [ ] Task 3: 创建邮件配置服务（AC: 4）
  - [ ] Subtask 3.1: 创建 `config/EmailConfig.java` 配置类
  - [ ] Subtask 3.2: 添加邮件相关配置项到 `application.yml`
  - [ ] Subtask 3.3: 实现邮件模板配置和格式化功能
  - [ ] Subtask 3.4: 实现邮件发送策略配置（实际发送 vs 日志记录）

- [ ] Task 4: 集成预警规则引擎（AC: 3）
  - [ ] Subtask 4.1: 修改 `AlertRuleEngineImpl`，集成邮件服务
  - [ ] Subtask 4.2: 在预警触发时调用邮件服务
  - [ ] Subtask 4.3: 根据预警规则确定邮件发送时机（30天、15天、7天、1天）
  - [ ] Subtask 4.4: 添加邮件预警的去重逻辑，避免重复发送

- [ ] Task 5: 编写单元测试（AC: 5）
  - [ ] Subtask 5.1: 创建 `test/service/EmailServiceTest.java` 测试类
  - [ ] Subtask 5.2: 编写 `testSendExpiryAlertEmail_LogMode()` 测试方法
  - [ ] Subtask 5.3: 编写 `testEmailLogFormat()` 测试邮件日志格式
  - [ ] Subtask 5.4: 编写 `testEmailConfigurationLoading()` 测试配置加载
  - [ ] Subtask 5.5: 创建 `test/infrastructure/external/email/LogEmailServiceTest.java` 测试日志邮件服务

- [ ] Task 6: 集成测试和功能验证（AC: 6）
  - [ ] Subtask 6.1: 创建集成测试，验证邮件服务与预警引擎的集成
  - [ ] Subtask 6.2: 创建测试数据，模拟不同预警场景的邮件发送
  - [ ] Subtask 6.3: 验证邮件日志记录的完整性和格式
  - [ ] Subtask 6.4: 验证邮件预警去重逻辑的正确性
  - [ ] Subtask 6.5: 验证配置切换功能（日志模式 vs 实际发送模式）

## Dev Notes

### 前一个故事的关键信息
基于 [Source: docs/stories/2.2.story.md#Dev Agent Record]：
- 预警规则引擎已完成，包括 AlertRuleEngine、AlertRuleConfigService
- 预警规则支持基于时间的规则（30天、15天、7天、1天）
- 预警规则引擎已集成到 MonitoringServiceImpl 中
- 监控日志记录功能已完整实现

### 技术栈配置
根据 [Source: architecture/3.tech-stack.md]：

**后端技术栈（必须使用）：**
- Java 8 - 后端开发语言
- Spring Boot 2.7.x - 后端框架
- MyBatis Plus 3.5.x - ORM框架
- MySQL 8.0 - 数据库
- Logback 1.3.x - 日志框架
- JUnit 5.x + Mockito 4.x - 测试框架

### 项目结构
根据 [Source: architecture/12.unified-project-structure.md]：

**邮件服务相关文件位置：**
```
backend/src/main/java/com/example/certificate/
├── service/
│   ├── EmailService.java                    # 邮件服务接口
│   └── impl/
│       └── EmailServiceImpl.java            # 邮件服务实现（生产环境）
├── infrastructure/
│   └── external/
│       └── email/
│           ├── LogEmailServiceImpl.java     # 日志邮件服务实现（MVP阶段）
│           └── EmailTemplate.java           # 邮件模板类
├── config/
│   └── EmailConfig.java                     # 邮件配置类
└── common/
    └── constant/
        └── EmailConstants.java              # 邮件相关常量
```

### 邮件服务设计
根据 [Source: architecture/11.backend-architecture.md#设计模式]：

**邮件服务接口：**
```java
public interface EmailService {
    /**
     * 发送证书过期预警邮件
     * @param certificate 证书信息
     * @param daysUntilExpiry 距离过期的天数
     * @param recipientEmail 收件人邮箱
     * @return 邮件发送结果
     */
    EmailResult sendExpiryAlertEmail(Certificate certificate, int daysUntilExpiry, String recipientEmail);
    
    /**
     * 发送每日证书状态摘要邮件
     * @param expiringSoonCertificates 即将过期的证书列表
     * @param expiredCertificates 已过期的证书列表
     * @param recipientEmail 收件人邮箱
     * @return 邮件发送结果
     */
    EmailResult sendDailySummary(List<Certificate> expiringSoonCertificates, 
                                List<Certificate> expiredCertificates, 
                                String recipientEmail);
}
```

**日志邮件服务实现：**
```java
@Service("logEmailService")
@Primary
public class LogEmailServiceImpl implements EmailService {
    private static final Logger log = LoggerFactory.getLogger(LogEmailServiceImpl.class);
    
    private final MonitoringLogService monitoringLogService;
    
    @Override
    public EmailResult sendExpiryAlertEmail(Certificate certificate, int daysUntilExpiry, String recipientEmail) {
        // 记录详细的邮件预警日志
        String logMessage = String.format(
            "邮件预警 - 收件人: %s, 证书: %s, 域名: %s, 到期日期: %s, 剩余天数: %d天", 
            recipientEmail, certificate.getName(), certificate.getDomain(), 
            certificate.getExpiryDate(), daysUntilExpiry);
        
        log.info(logMessage);
        
        // 记录监控日志到数据库
        monitoringLogService.logEmailAlert(certificate, daysUntilExpiry, recipientEmail);
        
        EmailResult result = new EmailResult();
        result.setSuccess(true);
        result.setMessage("Email alert logged (MVP mode)");
        result.setRecipient(recipientEmail);
        result.setSentAt(new Date());
        return result;
    }
    
    @Override
    public EmailResult sendDailySummary(List<Certificate> expiringSoonCertificates, 
                                       List<Certificate> expiredCertificates, 
                                       String recipientEmail) {
        String summaryMessage = String.format(
            "每日摘要 - 收件人: %s, 即将过期证书: %d个, 已过期证书: %d个",
            recipientEmail, expiringSoonCertificates.size(), expiredCertificates.size());
        
        log.info(summaryMessage);
        
        // 记录每个证书的详细信息
        expiringSoonCertificates.forEach(cert -> {
            log.info("即将过期 - 证书: {}, 域名: {}, 到期日期: {}", 
                    cert.getName(), cert.getDomain(), cert.getExpiryDate());
        });
        
        expiredCertificates.forEach(cert -> {
            log.info("已过期 - 证书: {}, 域名: {}, 到期日期: {}", 
                    cert.getName(), cert.getDomain(), cert.getExpiryDate());
        });
        
        // 记录监控日志
        monitoringLogService.logDailySummary(expiringSoonCertificates, expiredCertificates, recipientEmail);
        
        EmailResult result = new EmailResult();
        result.setSuccess(true);
        result.setMessage("Daily summary logged (MVP mode)");
        result.setRecipient(recipientEmail);
        result.setSentAt(new Date());
        return result;
    }
}
```

### 邮件结果模型
根据 [Source: architecture/4.data-models.md]：

**邮件发送结果：**
```java
public class EmailResult {
    private boolean success;
    private String message;
    private String recipient;
    private Date sentAt;
    private String errorCode;
    private String errorMessage;
    
    // getters and setters...
}
```

### 集成到预警系统
根据 [Source: architecture/8.core-workflows.md#证书预警工作流]：

**预警服务集成：**
```java
@Service
public class AlertServiceImpl implements AlertService {
    private final EmailService emailService;
    private final SmsService smsService;
    private final AlertRuleEngine alertRuleEngine;
    
    @Value("${alert.email.default-recipient}")
    private String defaultEmailRecipient;
    
    public void sendExpiryAlert(Certificate certificate, int daysUntilExpiry) {
        List<AlertRule> triggeredRules = alertRuleEngine.getTriggeredRules(certificate);
        
        for (AlertRule rule : triggeredRules) {
            List<String> channels = rule.getAlertChannels();
            
            if (channels.contains("EMAIL")) {
                EmailResult result = emailService.sendExpiryAlertEmail(
                    certificate, daysUntilExpiry, defaultEmailRecipient);
                
                if (!result.isSuccess()) {
                    log.error("邮件预警发送失败 - 证书: {}, 错误: {}", 
                             certificate.getName(), result.getErrorMessage());
                }
            }
            
            if (channels.contains("SMS")) {
                // 发送短信预警（将在下一个故事中实现）
                smsService.sendExpiryAlertSms(certificate, daysUntilExpiry, defaultSmsRecipient);
            }
        }
    }
}
```

### 配置管理
根据 [Source: architecture/11.backend-architecture.md#配置类]：

**邮件配置：**
```yaml
# application.yml
alert:
  email:
    enabled: true
    mode: log # log | real
    default-recipient: admin@example.com
    smtp:
      host: smtp.example.com
      port: 587
      username: noreply@example.com
      password: ${EMAIL_PASSWORD:}
      tls-enabled: true
    templates:
      expiry-alert:
        subject: "证书即将过期预警 - {certificateName}"
        template-path: "classpath:templates/email/expiry-alert.html"
      daily-summary:
        subject: "证书状态每日摘要"
        template-path: "classpath:templates/email/daily-summary.html"
```

**配置类：**
```java
@Configuration
@ConfigurationProperties(prefix = "alert.email")
@Data
public class EmailConfig {
    private boolean enabled = true;
    private String mode = "log"; // log | real
    private String defaultRecipient;
    private SmtpConfig smtp = new SmtpConfig();
    private Map<String, EmailTemplateConfig> templates = new HashMap<>();
    
    @Data
    public static class SmtpConfig {
        private String host;
        private int port = 587;
        private String username;
        private String password;
        private boolean tlsEnabled = true;
    }
    
    @Data
    public static class EmailTemplateConfig {
        private String subject;
        private String templatePath;
    }
}
```

### 监控日志扩展
根据 [Source: architecture/4.data-models.md]：

**监控日志服务扩展：**
```java
public interface MonitoringLogService {
    // 现有方法...
    
    /**
     * 记录邮件预警日志
     */
    void logEmailAlert(Certificate certificate, int daysUntilExpiry, String recipient);
    
    /**
     * 记录每日摘要日志
     */
    void logDailySummary(List<Certificate> expiringSoonCertificates, 
                        List<Certificate> expiredCertificates, 
                        String recipient);
}
```

### 错误处理策略
根据 [Source: architecture/11.backend-architecture.md#异常处理]：

**邮件服务异常处理：**
```java
public class EmailServiceException extends RuntimeException {
    private String recipient;
    private String certificateId;
    
    public EmailServiceException(String message, String recipient, String certificateId) {
        super(message);
        this.recipient = recipient;
        this.certificateId = certificateId;
    }
}

// 在邮件服务中的异常处理
try {
    return sendExpiryAlertEmail(certificate, daysUntilExpiry, recipientEmail);
} catch (Exception e) {
    log.error("邮件预警发送失败 - 收件人: {}, 证书ID: {}, 错误: {}", 
             recipientEmail, certificate.getId(), e.getMessage());
    
    EmailResult result = new EmailResult();
    result.setSuccess(false);
    result.setErrorMessage(e.getMessage());
    result.setErrorCode("EMAIL_SEND_FAILED");
    return result;
}
```

### 编码规范
根据 [Source: architecture/17.coding-standards.md]：

**命名规范：**
- 类名: PascalCase (如 `EmailService`)
- 方法/变量: camelCase (如 `sendExpiryAlertEmail`)
- 常量: UPPER_SNAKE_CASE (如 `DEFAULT_EMAIL_TEMPLATE`)
- 配置属性: kebab-case (如 `alert.email.default-recipient`)

**关键规则：**
- 使用构造函数注入依赖
- 接口与实现分离
- 每个方法都要有适当的日志记录
- 不能在日志或错误信息中暴露敏感信息

## Testing
根据 [Source: architecture/16.testing-strategy.md#后端测试]：

**测试标准：**
- 使用 JUnit 5 作为测试框架
- 使用 Mockito 进行依赖模拟
- 测试文件位置：`backend/src/test/java/com/example/certificate/`
- 测试命名：`XxxTest.java`
- 测试方法命名：`testMethodName_scenario_expectedResult()`
- 覆盖率目标：核心业务逻辑 80%+

**测试示例：**
```java
@ExtendWith(MockitoExtension.class)
class LogEmailServiceTest {
    @Mock
    private MonitoringLogService monitoringLogService;
    
    @InjectMocks
    private LogEmailServiceImpl logEmailService;
    
    @Test
    void testSendExpiryAlertEmail_LogMode_shouldLogAndReturnSuccess() {
        // Given
        Certificate certificate = createCertificate("测试证书", "test.example.com");
        int daysUntilExpiry = 15;
        String recipient = "admin@example.com";
        
        // When
        EmailResult result = logEmailService.sendExpiryAlertEmail(certificate, daysUntilExpiry, recipient);
        
        // Then
        assertTrue(result.isSuccess());
        assertEquals("Email alert logged (MVP mode)", result.getMessage());
        assertEquals(recipient, result.getRecipient());
        assertNotNull(result.getSentAt());
        
        verify(monitoringLogService).logEmailAlert(certificate, daysUntilExpiry, recipient);
    }
    
    @Test
    void testSendDailySummary_LogMode_shouldLogSummaryAndDetails() {
        // Given
        List<Certificate> expiringSoon = Arrays.asList(
            createCertificate("证书1", "site1.example.com"),
            createCertificate("证书2", "site2.example.com")
        );
        List<Certificate> expired = Arrays.asList(
            createCertificate("过期证书", "old.example.com")
        );
        String recipient = "admin@example.com";
        
        // When
        EmailResult result = logEmailService.sendDailySummary(expiringSoon, expired, recipient);
        
        // Then
        assertTrue(result.isSuccess());
        assertEquals("Daily summary logged (MVP mode)", result.getMessage());
        assertEquals(recipient, result.getRecipient());
        
        verify(monitoringLogService).logDailySummary(expiringSoon, expired, recipient);
    }
}
```

**运行测试命令：**
```bash
cd backend
mvn test -Dtest=LogEmailServiceTest
mvn test -Dtest=EmailServiceTest
mvn test # 运行所有测试
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-17 | 1.0 | 初始故事创建 | Bob (Scrum Master) |