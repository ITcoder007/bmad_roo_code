# Story 3.3: 基础搜索功能

## Status
Approved

## Story
**As a** 前端开发人员,
**I want** 实现基础的证书搜索功能,
**so that** 用户能够快速找到所需证书.

## Acceptance Criteria
1. 实现搜索框组件，支持输入搜索关键词
2. 实现按证书名称和域名的搜索功能
3. 添加搜索按钮，支持手动触发搜索
4. 实现搜索结果的实时展示
5. 添加清除搜索的功能
6. 确保搜索功能的响应时间不超过1秒
7. 在搜索结果中高亮匹配的关键词

## Tasks / Subtasks

- [ ] Task 1: 创建搜索组件基础结构 (AC: 1, 3, 5)
  - [ ] Subtask 1.1: 在 `frontend/src/components/business/CertificateSearchBox.vue` 中创建搜索框组件
  - [ ] Subtask 1.2: 使用 Element Plus Input 组件实现搜索输入框
  - [ ] Subtask 1.3: 添加搜索按钮和清除按钮，使用 Element Plus 图标
  - [ ] Subtask 1.4: 实现组件的 props 和 emits 接口定义

- [ ] Task 2: 实现搜索逻辑和防抖功能 (AC: 2, 4, 6)
  - [ ] Subtask 2.1: 实现防抖搜索功能，使用 useDebounce 组合函数
  - [ ] Subtask 2.2: 在证书列表页面集成搜索组件
  - [ ] Subtask 2.3: 扩展证书 store 添加搜索状态管理
  - [ ] Subtask 2.4: 实现搜索参数与列表筛选的集成

- [ ] Task 3: 实现搜索结果高亮显示 (AC: 7)
  - [ ] Subtask 3.1: 创建文本高亮工具函数 `frontend/src/utils/highlight.js`
  - [ ] Subtask 3.2: 在证书列表组件中集成高亮显示功能
  - [ ] Subtask 3.3: 使用正则表达式实现关键词匹配和高亮
  - [ ] Subtask 3.4: 添加高亮样式，使用醒目的背景色

- [ ] Task 4: 集成后端搜索API (AC: 2, 6)
  - [ ] Subtask 4.1: 扩展 `frontend/src/api/certificate.js` 添加搜索参数支持
  - [ ] Subtask 4.2: 修改 getCertificateList API 调用，支持 search 参数
  - [ ] Subtask 4.3: 实现搜索状态的 URL 同步，支持浏览器前进后退
  - [ ] Subtask 4.4: 添加搜索结果的加载状态和错误处理

- [ ] Task 5: 优化用户体验和交互 (AC: 3, 4, 5)
  - [ ] Subtask 5.1: 实现搜索快捷键支持（Enter 键搜索，Escape 键清除）
  - [ ] Subtask 5.2: 添加搜索历史记录功能（使用 localStorage）
  - [ ] Subtask 5.3: 实现搜索建议和自动完成（可选）
  - [ ] Subtask 5.4: 添加搜索结果数量显示和空状态处理

- [ ] Task 6: 编写测试用例 (AC: 1-7)
  - [ ] Subtask 6.1: 创建 `frontend/tests/unit/components/business/CertificateSearchBox.spec.js` 测试文件
  - [ ] Subtask 6.2: 编写搜索组件渲染和交互的测试用例
  - [ ] Subtask 6.3: 编写防抖功能和搜索触发的测试用例
  - [ ] Subtask 6.4: 编写高亮显示功能的测试用例
  - [ ] Subtask 6.5: 编写搜索集成测试，包含API调用和状态更新
  - [ ] Subtask 6.6: 编写工具函数测试 `frontend/tests/unit/utils/highlight.spec.js`

## Dev Notes

### 前一个故事的关键信息
基于 [Source: docs/stories/3.2.story.md#Dev Agent Record]：
- 证书详情页面已完成，包含完整的状态管理和组件架构
- CertificateStatusBadge 组件已实现，可复用于搜索结果展示
- 证书状态管理(certificate store)已完善，支持 CRUD 操作和状态计算
- BaseTable、BaseDialog、Loading 等通用组件已可用
- 工具函数 date.js 已实现，提供日期格式化功能

### 技术栈配置
根据 [Source: architecture/3.tech-stack.md]：

**前端技术栈（必须使用）：**
- Vue.js 3.x - 响应式用户界面框架
- Vue Router 4.x - 前端路由管理
- Pinia 2.x - 状态管理
- Element Plus 2.x - UI 组件库
- Vite 4.x - 构建工具
- JavaScript ES2020+ - 开发语言
- Vitest 1.x + Vue Test Utils 2.x - 测试框架

### 项目结构
根据 [Source: architecture/12.unified-project-structure.md]：

**搜索功能相关文件位置：**
```
frontend/src/
├── views/certificate/
│   └── CertificateList.vue              # 证书列表页面（需要集成搜索组件）
├── components/business/
│   ├── CertificateSearchBox.vue         # 搜索框组件（新建）
│   └── CertificateStatusBadge.vue       # 证书状态徽章组件（已存在，可复用）
├── stores/modules/
│   └── certificate.js                   # 证书状态管理（需要扩展搜索功能）
├── api/
│   └── certificate.js                   # 证书API接口（需要扩展搜索参数）
├── utils/
│   ├── date.js                          # 日期工具（已存在）
│   └── highlight.js                     # 文本高亮工具（新建）
├── composables/
│   └── useDebounce.js                   # 防抖组合函数（已存在）
└── router/modules/
    └── certificate.js                   # 证书路由模块（已存在）
```

### 前端架构设计
根据 [Source: architecture/10.frontend-architecture.md]：

**Vue 3 组合式API搜索组件结构：**
```javascript
// CertificateSearchBox.vue 组件结构示例
<template>
  <div class="certificate-search-box">
    <el-input
      v-model="searchQuery"
      placeholder="搜索证书名称或域名..."
      clearable
      @clear="handleClear"
      @keydown.enter="handleSearch"
      @keydown.escape="handleClear"
      class="search-input"
    >
      <template #suffix>
        <el-button 
          type="primary" 
          :icon="Search" 
          @click="handleSearch"
          :loading="loading"
          class="search-button"
        >
          搜索
        </el-button>
      </template>
    </el-input>
    
    <!-- 搜索历史 -->
    <div v-if="showHistory && searchHistory.length > 0" class="search-history">
      <div class="history-header">
        <span>搜索历史</span>
        <el-button type="text" @click="clearHistory">清除历史</el-button>
      </div>
      <div class="history-items">
        <el-tag
          v-for="(item, index) in searchHistory"
          :key="index"
          @click="selectHistoryItem(item)"
          closable
          @close="removeHistoryItem(index)"
          class="history-tag"
        >
          {{ item }}
        </el-tag>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted } from 'vue'
import { Search } from '@element-plus/icons-vue'
import { useDebounce } from '@/composables/useDebounce'

// Props
const props = defineProps({
  modelValue: {
    type: String,
    default: ''
  },
  loading: {
    type: Boolean,
    default: false
  },
  placeholder: {
    type: String,
    default: '搜索证书名称或域名...'
  }
})

// Emits
const emit = defineEmits(['update:modelValue', 'search', 'clear'])

// 响应式数据
const searchQuery = ref(props.modelValue)
const showHistory = ref(false)
const searchHistory = ref([])

// 防抖搜索
const debouncedSearch = useDebounce((query) => {
  if (query.trim()) {
    emit('search', query.trim())
    addToHistory(query.trim())
  }
}, 300)

// 计算属性
const trimmedQuery = computed(() => searchQuery.value?.trim() || '')

// 方法
const handleSearch = () => {
  if (trimmedQuery.value) {
    emit('search', trimmedQuery.value)
    addToHistory(trimmedQuery.value)
    showHistory.value = false
  }
}

const handleClear = () => {
  searchQuery.value = ''
  emit('update:modelValue', '')
  emit('clear')
  showHistory.value = false
}

const addToHistory = (query) => {
  if (!searchHistory.value.includes(query)) {
    searchHistory.value.unshift(query)
    if (searchHistory.value.length > 10) {
      searchHistory.value = searchHistory.value.slice(0, 10)
    }
    saveHistoryToStorage()
  }
}

const selectHistoryItem = (item) => {
  searchQuery.value = item
  emit('update:modelValue', item)
  emit('search', item)
  showHistory.value = false
}

const removeHistoryItem = (index) => {
  searchHistory.value.splice(index, 1)
  saveHistoryToStorage()
}

const clearHistory = () => {
  searchHistory.value = []
  saveHistoryToStorage()
  showHistory.value = false
}

const loadHistoryFromStorage = () => {
  try {
    const history = localStorage.getItem('certificate-search-history')
    if (history) {
      searchHistory.value = JSON.parse(history)
    }
  } catch (error) {
    console.warn('Failed to load search history:', error)
  }
}

const saveHistoryToStorage = () => {
  try {
    localStorage.setItem('certificate-search-history', JSON.stringify(searchHistory.value))
  } catch (error) {
    console.warn('Failed to save search history:', error)
  }
}

// 监听器
watch(
  () => props.modelValue,
  (newValue) => {
    searchQuery.value = newValue
  }
)

watch(searchQuery, (newValue) => {
  emit('update:modelValue', newValue)
  if (newValue.trim()) {
    debouncedSearch(newValue)
  }
})

// 生命周期
onMounted(() => {
  loadHistoryFromStorage()
})
</script>

<style scoped>
.certificate-search-box {
  position: relative;
  width: 100%;
  max-width: 400px;
}

.search-input {
  width: 100%;
}

.search-button {
  margin-left: 8px;
  border-radius: 0 4px 4px 0;
}

.search-history {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #dcdfe6;
  border-radius: 4px;
  box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
  z-index: 1000;
  margin-top: 4px;
  padding: 12px;
}

.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 12px;
  color: #909399;
}

.history-items {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.history-tag {
  cursor: pointer;
  transition: all 0.2s;
}

.history-tag:hover {
  background-color: #ecf5ff;
  border-color: #409eff;
}
</style>
```

### 文本高亮工具函数
根据 [Source: architecture/12.unified-project-structure.md#前端工具函数]：

**高亮工具函数设计：**
```javascript
// utils/highlight.js
/**
 * 高亮匹配的文本
 * @param {string} text - 原始文本
 * @param {string} keyword - 搜索关键词
 * @param {string} className - 高亮样式类名
 * @returns {string} 包含高亮标签的HTML字符串
 */
export function highlightText(text, keyword, className = 'highlight') {
  if (!text || !keyword) return text
  
  try {
    // 转义特殊字符
    const escapedKeyword = keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
    const regex = new RegExp(`(${escapedKeyword})`, 'gi')
    
    return text.replace(regex, `<span class="${className}">$1</span>`)
  } catch (error) {
    console.warn('Failed to highlight text:', error)
    return text
  }
}

/**
 * 高亮多个关键词
 * @param {string} text - 原始文本
 * @param {string[]} keywords - 搜索关键词数组
 * @param {string} className - 高亮样式类名
 * @returns {string} 包含高亮标签的HTML字符串
 */
export function highlightMultipleKeywords(text, keywords, className = 'highlight') {
  if (!text || !keywords || keywords.length === 0) return text
  
  let result = text
  keywords.forEach(keyword => {
    if (keyword.trim()) {
      result = highlightText(result, keyword.trim(), className)
    }
  })
  
  return result
}

/**
 * 检查文本是否包含关键词
 * @param {string} text - 原始文本
 * @param {string} keyword - 搜索关键词
 * @returns {boolean} 是否包含关键词
 */
export function containsKeyword(text, keyword) {
  if (!text || !keyword) return false
  
  return text.toLowerCase().includes(keyword.toLowerCase())
}
```

### 状态管理扩展
根据 [Source: architecture/10.frontend-architecture.md#状态管理]：

**Certificate Store 搜索功能扩展：**
```javascript
// stores/modules/certificate.js
export const useCertificateStore = defineStore('certificate', {
  state: () => ({
    // 现有状态...
    certificates: [],
    currentCertificate: null,
    loading: false,
    
    // 新增搜索相关状态
    searchQuery: '',
    searchLoading: false,
    searchResults: [],
    filteredCertificates: [],
    
    // 分页和筛选状态
    pagination: {
      page: 1,
      size: 20,
      total: 0
    },
    filters: {
      status: '',
      search: ''
    }
  }),

  getters: {
    // 现有getters...
    
    // 搜索相关getters
    hasSearchQuery: (state) => state.searchQuery.trim() !== '',
    
    searchResultsCount: (state) => state.searchResults.length,
    
    isSearching: (state) => state.searchLoading,
    
    displayCertificates: (state) => {
      return state.hasSearchQuery ? state.searchResults : state.certificates
    }
  },

  actions: {
    // 现有方法...
    
    // 搜索相关方法
    async searchCertificates(query) {
      this.searchQuery = query
      this.searchLoading = true
      
      try {
        const searchParams = {
          ...this.filters,
          search: query,
          page: this.pagination.page,
          size: this.pagination.size
        }
        
        const response = await getCertificateList(searchParams)
        
        if (query === this.searchQuery) { // 避免过时的请求覆盖新结果
          this.searchResults = response.data.content
          this.pagination.total = response.data.totalElements
        }
      } catch (error) {
        console.error('搜索证书失败:', error)
        this.searchResults = []
        throw error
      } finally {
        this.searchLoading = false
      }
    },
    
    clearSearch() {
      this.searchQuery = ''
      this.searchResults = []
      this.searchLoading = false
      // 重新加载完整列表
      this.fetchCertificates()
    },
    
    updateSearchQuery(query) {
      this.searchQuery = query
      if (!query.trim()) {
        this.clearSearch()
      }
    }
  }
})
```

### API 接口规范
根据 [Source: architecture/5.api-specs.md]：

**证书搜索API扩展：**
```javascript
// api/certificate.js
/**
 * 获取证书列表（支持搜索）
 * @param {Object} params 查询参数
 * @param {number} params.page 页码
 * @param {number} params.size 每页大小
 * @param {string} params.sort 排序字段
 * @param {string} params.status 状态筛选
 * @param {string} params.search 搜索关键词
 * @returns {Promise} API响应
 */
export function getCertificateList(params = {}) {
  return api.get('/api/v1/certificates', { params })
}

/**
 * 搜索证书建议
 * @param {string} query 搜索查询
 * @param {number} limit 结果限制
 * @returns {Promise} API响应
 */
export function searchCertificateSuggestions(query, limit = 5) {
  return api.get('/api/v1/certificates/suggestions', {
    params: { q: query, limit }
  })
}
```

**搜索API端点详情：**
- **基础搜索**：`GET /api/v1/certificates?search={keyword}` - 按名称和域名搜索
- **响应时间要求**：< 1秒
- **搜索字段**：证书名称(name)、域名(domain)
- **搜索类型**：模糊匹配，不区分大小写

### 编码规范
根据 [Source: architecture/17.coding-standards.md]：

**关键规则：**
- 组件名称：PascalCase (`CertificateSearchBox.vue`)
- 方法/变量：camelCase (`searchQuery`, `handleSearch`)
- API调用：通过服务层，不直接使用HTTP客户端
- 状态管理：通过Pinia store，不直接变更状态
- 表单验证：所有用户输入必须验证
- 错误处理：统一错误处理和用户反馈
- 性能优化：使用防抖避免频繁API调用

### 响应式设计
根据 [Source: architecture/10.frontend-architecture.md#样式设计]：

**搜索组件响应式要求：**
```scss
// 搜索组件样式设计
.certificate-search-box {
  width: 100%;
  max-width: 400px;
  
  @include respond-to('sm') {
    max-width: 300px;
  }
  
  .search-input {
    .el-input__wrapper {
      border-radius: 4px;
      transition: all 0.2s;
      
      &:hover {
        border-color: #409eff;
      }
      
      &.is-focus {
        border-color: #409eff;
        box-shadow: 0 0 0 2px rgba(64, 158, 255, 0.2);
      }
    }
  }
  
  .highlight {
    background-color: #fff3cd;
    color: #856404;
    padding: 0 2px;
    border-radius: 2px;
    font-weight: 500;
  }
}
```

### 数据模型
根据 [Source: architecture/4.data-models.md]：

**Certificate 接口（已存在）：**
```typescript
interface Certificate {
  id: number;
  name: string;        // 可搜索字段
  domain: string;      // 可搜索字段
  issuer: string;
  issueDate: Date;
  expiryDate: Date;
  certificateType: string;
  status: 'NORMAL' | 'EXPIRING_SOON' | 'EXPIRED';
  createdAt: Date;
  updatedAt: Date;
}
```

### Testing
根据 [Source: architecture/16.testing-strategy.md#前端测试]：

**测试标准：**
- 使用 Vitest 作为测试框架
- 使用 Vue Test Utils 进行组件测试
- 测试文件位置：`frontend/tests/unit/`
- 测试命名：`CertificateSearchBox.spec.js`
- 覆盖率目标：搜索功能和组件逻辑 80%+

**测试示例：**
```javascript
// tests/unit/components/business/CertificateSearchBox.spec.js
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { mount } from '@vue/test-utils'
import { createPinia, setActivePinia } from 'pinia'
import CertificateSearchBox from '@/components/business/CertificateSearchBox.vue'

describe('CertificateSearchBox.vue', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  it('should emit search event when search button clicked', async () => {
    const wrapper = mount(CertificateSearchBox)
    
    const input = wrapper.find('input')
    await input.setValue('test search')
    
    const searchButton = wrapper.find('[data-testid="search-button"]')
    await searchButton.trigger('click')
    
    expect(wrapper.emitted('search')).toBeTruthy()
    expect(wrapper.emitted('search')[0]).toEqual(['test search'])
  })

  it('should emit search event with debounce when typing', async () => {
    vi.useFakeTimers()
    
    const wrapper = mount(CertificateSearchBox)
    const input = wrapper.find('input')
    
    await input.setValue('test')
    
    // 快速输入不应该触发搜索
    expect(wrapper.emitted('search')).toBeFalsy()
    
    // 等待防抖延迟
    vi.advanceTimersByTime(300)
    
    expect(wrapper.emitted('search')).toBeTruthy()
    expect(wrapper.emitted('search')[0]).toEqual(['test'])
    
    vi.useRealTimers()
  })

  it('should clear search when clear button clicked', async () => {
    const wrapper = mount(CertificateSearchBox, {
      props: { modelValue: 'test search' }
    })
    
    const clearButton = wrapper.find('[data-testid="clear-button"]')
    await clearButton.trigger('click')
    
    expect(wrapper.emitted('clear')).toBeTruthy()
    expect(wrapper.emitted('update:modelValue')).toBeTruthy()
    expect(wrapper.emitted('update:modelValue')[0]).toEqual([''])
  })

  it('should handle Enter key to trigger search', async () => {
    const wrapper = mount(CertificateSearchBox)
    const input = wrapper.find('input')
    
    await input.setValue('test search')
    await input.trigger('keydown.enter')
    
    expect(wrapper.emitted('search')).toBeTruthy()
    expect(wrapper.emitted('search')[0]).toEqual(['test search'])
  })

  it('should handle Escape key to clear search', async () => {
    const wrapper = mount(CertificateSearchBox, {
      props: { modelValue: 'test search' }
    })
    
    const input = wrapper.find('input')
    await input.trigger('keydown.escape')
    
    expect(wrapper.emitted('clear')).toBeTruthy()
  })
})
```

**运行测试命令：**
```bash
cd frontend
npm run test -- CertificateSearchBox.spec.js
npm run test:coverage # 运行覆盖率测试
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-17 | 1.0 | 初始故事创建 | Bob (Scrum Master) |