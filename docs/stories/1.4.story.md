# Story 1.4: 基础证书状态计算

## Status
Ready for Review

## Story
**As a** 系统开发人员,
**I want** 实现证书状态的基本计算功能,
**so that** 系统能够判断证书的有效性状态.

## Acceptance Criteria
1. 实现证书状态计算逻辑，包括正常、即将过期、已过期等状态
2. 定义基本的状态判断规则，如到期前30天为"即将过期"
3. 在API响应中包含证书状态信息
4. 实现基于状态的证书筛选功能
5. 编写状态计算功能的单元测试
6. 验证状态计算的基本准确性

## Tasks / Subtasks
- [x] Task 1: 增强证书领域模型的状态计算功能 (AC: 1, 2)
  - [x] Subtask 1.1: 在 `backend/src/main/java/com/example/certificate/domain/model/Certificate.java` 中验证现有的 calculateStatus() 方法
  - [x] Subtask 1.2: 确保状态计算逻辑符合业务规则（30天内即将过期，0天内已过期）
  - [x] Subtask 1.3: 添加 getDaysUntilExpiry() 方法计算距离到期的天数
  - [x] Subtask 1.4: 添加 isExpiringSoon(int days) 方法支持动态阈值判断
  - [x] Subtask 1.5: 在 CertificateStatus 枚举中确保所有状态值已定义

- [x] Task 2: 创建证书状态服务层 (AC: 1, 2)
  - [x] Subtask 2.1: 在 `backend/src/main/java/com/example/certificate/service/` 创建 CertificateStatusService.java 接口
  - [x] Subtask 2.2: 定义方法：calculateStatus, bulkCalculateStatus, getDaysUntilExpiry
  - [x] Subtask 2.3: 在 `backend/src/main/java/com/example/certificate/service/impl/` 创建 CertificateStatusServiceImpl.java 实现类
  - [x] Subtask 2.4: 实现状态计算逻辑，注入必要的配置（阈值天数）
  - [x] Subtask 2.5: 添加 @Service 注解和适当的日志记录

- [x] Task 3: 增强服务层以包含状态信息 (AC: 3)
  - [x] Subtask 3.1: 修改 CertificateServiceImpl 的 getCertificateById 方法，确保返回的证书包含计算后的状态
  - [x] Subtask 3.2: 修改 getCertificateList 方法，为每个证书计算并设置状态
  - [x] Subtask 3.3: 在创建和更新证书时自动计算并设置状态
  - [x] Subtask 3.4: 确保 CertificateDto 包含 status 字段和 daysUntilExpiry 字段
  - [x] Subtask 3.5: 在 CertificateServiceConverter 中添加状态转换逻辑

- [x] Task 4: 实现基于状态的筛选功能 (AC: 4)
  - [x] Subtask 4.1: 在 CertificateQueryRequest 中添加 status 筛选参数
  - [x] Subtask 4.2: 在 CertificateRepositoryImpl 中实现基于状态的查询逻辑
  - [x] Subtask 4.3: 在 MyBatis 映射文件中添加状态筛选的 SQL 条件
  - [x] Subtask 4.4: 支持多状态筛选（如同时筛选 EXPIRING_SOON 和 EXPIRED）
  - [x] Subtask 4.5: 在控制器层验证状态筛选参数的有效性

- [x] Task 5: 创建定时任务更新证书状态 (AC: 1, 2)
  - [x] Subtask 5.1: 在 `backend/src/main/java/com/example/certificate/scheduler/` 创建 CertificateStatusScheduler.java
  - [x] Subtask 5.2: 使用 @Scheduled 注解配置定时任务（每天凌晨执行）
  - [x] Subtask 5.3: 实现批量更新所有证书状态的逻辑
  - [x] Subtask 5.4: 添加任务执行日志和性能监控
  - [x] Subtask 5.5: 实现任务失败的重试机制

- [x] Task 6: 配置状态计算参数 (AC: 2)
  - [x] Subtask 6.1: 在 application.yml 中添加证书状态配置节
  - [x] Subtask 6.2: 配置 certificate.status.expiring-soon-days 参数（默认30天）
  - [x] Subtask 6.3: 创建 CertificateStatusConfig 配置类读取配置值
  - [x] Subtask 6.4: 支持通过环境变量覆盖配置
  - [x] Subtask 6.5: 添加配置值验证（必须为正整数）

- [x] Task 7: 编写状态计算单元测试 (AC: 5)
  - [x] Subtask 7.1: 在 `backend/src/test/java/com/example/certificate/domain/model/` 创建 CertificateStatusTest.java
  - [x] Subtask 7.2: 测试正常状态的计算（距离到期 > 30天）
  - [x] Subtask 7.3: 测试即将过期状态的计算（距离到期 1-30天）
  - [x] Subtask 7.4: 测试已过期状态的计算（距离到期 <= 0天）
  - [x] Subtask 7.5: 测试边界条件（正好30天、正好0天）
  - [x] Subtask 7.6: 测试 getDaysUntilExpiry 方法的准确性

- [x] Task 8: 编写服务层状态功能测试 (AC: 5, 6)
  - [x] Subtask 8.1: 在 `backend/src/test/java/com/example/certificate/service/` 创建 CertificateStatusServiceTest.java
  - [x] Subtask 8.2: 测试单个证书状态计算
  - [x] Subtask 8.3: 测试批量证书状态计算的性能
  - [x] Subtask 8.4: 测试状态筛选功能的准确性
  - [x] Subtask 8.5: 测试配置参数变更对状态计算的影响
  - [x] Subtask 8.6: 验证状态计算的时区处理

- [x] Task 9: 集成测试验证 (AC: 6)
  - [x] Subtask 9.1: 创建集成测试验证状态计算在API层的表现
  - [x] Subtask 9.2: 测试证书列表API返回的状态信息
  - [x] Subtask 9.3: 测试基于状态的筛选API功能
  - [x] Subtask 9.4: 验证定时任务的执行效果
  - [x] Subtask 9.5: 确保状态计算的一致性和准确性

## Dev Notes

### 前一个故事的关键信息
基于 [Source: docs/stories/1.3.story.md#Dev Agent Record]：
- 核心证书管理API已完成，包括完整的CRUD操作
- 统一的响应格式 ApiResponse 已实现
- 全局异常处理 GlobalExceptionHandler 已配置
- 分页查询功能已实现，支持 PageRequest 和 CertificateQueryRequest
- 证书服务层 CertificateService 和实现类已创建
- 数据验证使用 JSR-303 标准注解
- MyBatis Plus 分页插件已配置
- 单元测试框架已搭建（JUnit 5 + Mockito）

### 证书状态定义
根据 [Source: architecture/data-models.md#Certificate]：

**证书状态枚举：**
```java
public enum CertificateStatus {
    NORMAL,        // 正常（距离到期 > 30天）
    EXPIRING_SOON, // 即将过期（距离到期 <= 30天）
    EXPIRED        // 已过期（已经过期）
}
```

### 状态计算业务规则
根据 [Source: architecture/core-workflows.md#证书监控工作流]：

**状态计算规则：**
- NORMAL：距离到期超过30天
- EXPIRING_SOON：距离到期30天以内（含30天）
- EXPIRED：已过期

**监控配置：**
```yaml
monitoring:
  status-rules:
    expiring-soon-threshold: 30 # 距离到期30天以内为即将过期
    expired-threshold: 0 # 距离到期0天以内为已过期
```

### 领域模型位置
根据 [Source: architecture/backend-architecture.md#领域层]：

**领域模型文件：**
- 证书实体：`backend/src/main/java/com/example/certificate/domain/model/Certificate.java`
- 状态枚举：`backend/src/main/java/com/example/certificate/domain/model/CertificateStatus.java`
- 领域服务：`backend/src/main/java/com/example/certificate/domain/service/CertificateDomainService.java`

### 服务层架构
根据 [Source: architecture/backend-architecture.md#服务层]：

**服务层组件：**
- 服务接口位置：`backend/src/main/java/com/example/certificate/service/`
- 服务实现位置：`backend/src/main/java/com/example/certificate/service/impl/`
- DTO对象位置：`backend/src/main/java/com/example/certificate/service/dto/`
- 转换器位置：`backend/src/main/java/com/example/certificate/service/converter/`

### 定时任务配置
根据 [Source: architecture/tech-stack.md#定时任务框架]：

**Spring Scheduler配置：**
- 使用 Spring Boot 内置的 Spring Scheduler
- 配置类位置：`backend/src/main/java/com/example/certificate/config/SchedulerConfig.java`
- 定时任务位置：`backend/src/main/java/com/example/certificate/scheduler/`

### 配置管理
根据 [Source: architecture/backend-architecture.md#配置管理]：

**配置文件：**
- 主配置文件：`backend/src/main/resources/application.yml`
- 配置类位置：`backend/src/main/java/com/example/certificate/config/`

**配置示例：**
```yaml
certificate:
  status:
    expiring-soon-days: 30
    check-interval: 86400000 # 24小时（毫秒）
```

### 测试要求
根据 [Source: architecture/testing-strategy.md#后端测试]：

**单元测试：**
- 测试框架：JUnit 5.8.x + Mockito 4.5.x
- 领域模型测试：`backend/src/test/java/com/example/certificate/domain/model/`
- 服务层测试：`backend/src/test/java/com/example/certificate/service/`
- 使用 @ExtendWith(MockitoExtension.class) 进行Mock配置

**测试覆盖要求：**
- 核心业务逻辑覆盖率 > 70%
- 状态计算逻辑必须100%覆盖
- 边界条件必须测试

### 技术实现提示
- 利用Java 8的 LocalDate 和 ChronoUnit 进行日期计算
- 使用 @Value 注解注入配置值
- 使用 @Slf4j 注解（Lombok）进行日志记录
- 定时任务使用 @Scheduled(cron = "0 0 0 * * ?") 每天凌晨执行
- 批量更新时使用事务确保数据一致性
- 考虑时区问题，统一使用UTC时间进行计算

### Testing
根据 [Source: architecture/testing-strategy.md#测试组织结构]：

**测试文件组织：**
- 单元测试位置：`backend/src/test/java/com/example/certificate/`
  - 领域模型测试：`domain/model/`
  - 服务层测试：`service/`
  - 控制器测试：`controller/`

**测试标准：**
- 使用 JUnit 5 断言API
- 使用 Mockito 进行依赖模拟
- 测试方法命名：`methodName_scenario_expectedResult`
- 每个测试方法只测试一个场景
- 使用 @DisplayName 提供清晰的测试描述

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-15 | 1.0 | 初始故事创建 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- 证书状态计算逻辑位置：`backend/src/main/java/com/example/certificate/domain/model/Certificate.java:31-56`
- 证书状态服务位置：`backend/src/main/java/com/example/certificate/service/impl/CertificateStatusServiceImpl.java`
- 定时任务调度器位置：`backend/src/main/java/com/example/certificate/scheduler/CertificateStatusScheduler.java`
- 配置类位置：`backend/src/main/java/com/example/certificate/config/CertificateStatusConfig.java`

### Completion Notes
1. ✅ 增强了证书领域模型，支持动态阈值状态计算
2. ✅ 创建了专门的证书状态服务层，包含批量处理功能
3. ✅ 更新了服务层转换器，确保API响应包含状态和到期天数信息
4. ✅ 实现了多状态筛选功能，支持组合查询条件
5. ✅ 创建了定时任务调度器，支持重试机制和性能监控
6. ✅ 完整的配置管理，支持环境变量覆盖
7. ✅ 编写了18个单元测试，覆盖领域模型的所有状态计算场景
8. ✅ 编写了16个服务层测试，包含性能测试和边界条件
9. ✅ 编写了集成测试，验证API层的状态计算表现

### File List
**新增文件：**
- `backend/src/main/java/com/example/certificate/service/CertificateStatusService.java` - 证书状态服务接口
- `backend/src/main/java/com/example/certificate/service/impl/CertificateStatusServiceImpl.java` - 证书状态服务实现
- `backend/src/main/java/com/example/certificate/scheduler/CertificateStatusScheduler.java` - 定时任务调度器
- `backend/src/main/java/com/example/certificate/config/SchedulerConfig.java` - 调度器配置
- `backend/src/main/java/com/example/certificate/config/CertificateStatusConfig.java` - 证书状态配置类
- `backend/src/test/java/com/example/certificate/domain/model/CertificateStatusTest.java` - 领域模型测试
- `backend/src/test/java/com/example/certificate/service/CertificateStatusServiceTest.java` - 服务层测试
- `backend/src/test/java/com/example/certificate/integration/CertificateStatusIntegrationTest.java` - 集成测试

**修改文件：**
- `backend/src/main/java/com/example/certificate/domain/model/Certificate.java` - 增强状态计算功能
- `backend/src/main/java/com/example/certificate/service/dto/CertificateDto.java` - 添加daysUntilExpiry字段
- `backend/src/main/java/com/example/certificate/service/converter/CertificateServiceConverter.java` - 增强状态转换逻辑
- `backend/src/main/java/com/example/certificate/service/CertificateService.java` - 添加新查询方法
- `backend/src/main/java/com/example/certificate/service/impl/CertificateServiceImpl.java` - 集成状态服务
- `backend/src/main/java/com/example/certificate/controller/request/CertificateQueryRequest.java` - 支持多状态筛选
- `backend/src/main/java/com/example/certificate/domain/repository/CertificateRepository.java` - 添加状态相关方法
- `backend/src/main/java/com/example/certificate/infrastructure/repository/impl/CertificateRepositoryImpl.java` - 实现状态筛选查询
- `backend/src/main/resources/application.yml` - 添加证书状态配置

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-15 | 1.0 | 初始故事创建 | Bob (Scrum Master) |
| 2025-08-15 | 1.1 | 完成所有9个任务的开发实现 | James (Dev Agent) |
| 2025-08-15 | 1.2 | 通过单元测试验证，修复Java 8兼容性问题 | James (Dev Agent) |

## QA Results