# Story 2.2: 简化预警规则

## Status
Ready for Review

## Story
**As a** 系统开发人员,
**I want** 实现简化的预警规则,
**so that** 系统能够判断何时发送预警.

## Acceptance Criteria
1. 实现基于时间点的预警规则（如30天、15天、7天、1天）
2. 实现规则匹配和判断逻辑
3. 添加规则的基本配置功能
4. 编写规则引擎的单元测试
5. 验证规则引擎的基本准确性

## Tasks / Subtasks
- [x] Task 1: 创建预警规则数据模型 (AC: 1)
  - [x] Subtask 1.1: 创建 `domain/model/AlertRule.java` 实体类，定义预警规则属性
  - [x] Subtask 1.2: 创建 `domain/model/AlertRuleType.java` 枚举，定义预警规则类型
  - [x] Subtask 1.3: 创建 `domain/model/AlertTriggerCondition.java` 实体类，定义触发条件
  - [x] Subtask 1.4: 定义预警规则的业务验证逻辑

- [x] Task 2: 实现预警规则引擎 (AC: 2)
  - [x] Subtask 2.1: 创建 `service/AlertRuleEngine.java` 接口，定义规则引擎契约
  - [x] Subtask 2.2: 创建 `service/impl/AlertRuleEngineImpl.java` 实现类
  - [x] Subtask 2.3: 实现 `evaluateRules(Certificate certificate)` 方法，判断是否触发预警
  - [x] Subtask 2.4: 实现 `getTriggeredRules(Certificate certificate)` 方法，获取被触发的规则
  - [x] Subtask 2.5: 实现规则优先级处理逻辑

- [x] Task 3: 创建预警规则配置服务 (AC: 3)
  - [x] Subtask 3.1: 创建 `service/AlertRuleConfigService.java` 接口
  - [x] Subtask 3.2: 创建 `service/impl/AlertRuleConfigServiceImpl.java` 实现类
  - [x] Subtask 3.3: 实现预警规则的加载和缓存机制
  - [x] Subtask 3.4: 实现基础预警规则的初始化（30天、15天、7天、1天）
  - [x] Subtask 3.5: 实现规则配置的验证逻辑

- [x] Task 4: 集成规则引擎到监控服务 (AC: 2)
  - [x] Subtask 4.1: 修改 `MonitoringServiceImpl.java`，集成预警规则引擎
  - [x] Subtask 4.2: 在监控流程中调用规则引擎判断是否需要发送预警
  - [x] Subtask 4.3: 实现基于规则结果的预警触发逻辑
  - [x] Subtask 4.4: 添加规则评估的日志记录

- [x] Task 5: 编写单元测试 (AC: 4)
  - [x] Subtask 5.1: 创建 `test/service/AlertRuleEngineTest.java` 测试类
  - [x] Subtask 5.2: 编写 `testEvaluateRules_30DaysRule()` 测试方法
  - [x] Subtask 5.3: 编写 `testEvaluateRules_MultipleDaysRules()` 测试方法
  - [x] Subtask 5.4: 编写 `testGetTriggeredRules()` 测试方法
  - [x] Subtask 5.5: 编写规则引擎边界情况的测试用例
  - [x] Subtask 5.6: 创建 `test/service/AlertRuleConfigServiceTest.java` 测试配置服务

- [x] Task 6: 集成测试和功能验证 (AC: 5)
  - [x] Subtask 6.1: 创建集成测试，验证规则引擎与监控服务的集成
  - [x] Subtask 6.2: 创建测试数据，包含不同到期天数的证书
  - [x] Subtask 6.3: 验证30天规则的准确性
  - [x] Subtask 6.4: 验证15天、7天、1天规则的准确性
  - [x] Subtask 6.5: 验证规则优先级和多规则触发场景

## Dev Notes

### 前一个故事的关键信息
基于 [Source: docs/stories/2.1.story.md#Dev Agent Record]：
- 基础证书监控服务已完成，包括定时任务、状态计算、监控日志记录
- `MonitoringService` 和 `MonitoringServiceImpl` 已实现证书监控核心功能
- 证书状态计算逻辑已实现（NORMAL、EXPIRING_SOON、EXPIRED）
- 监控日志记录功能已完整实现
- 定时任务调度器已配置完成（每小时执行一次）

### 技术栈配置
根据 [Source: architecture/3.tech-stack.md]：

**后端技术栈（必须使用）：**
- Java 8 - 后端开发语言
- Spring Boot 2.7.x - 后端框架
- MyBatis Plus 3.5.x - ORM框架
- MySQL 8.0 - 数据库
- Logback 1.3.x - 日志框架
- JUnit 5.x + Mockito 4.x - 测试框架

### 项目结构
根据 [Source: architecture/11.backend-architecture.md#项目结构]：

**预警规则相关文件位置：**
```
backend/src/main/java/com/example/certificate/
├── service/
│   ├── AlertRuleEngine.java                # 预警规则引擎接口
│   ├── AlertRuleEngineImpl.java            # 预警规则引擎实现
│   ├── AlertRuleConfigService.java         # 预警规则配置服务接口
│   └── AlertRuleConfigServiceImpl.java     # 预警规则配置服务实现
├── domain/
│   ├── model/
│   │   ├── AlertRule.java                  # 预警规则实体
│   │   ├── AlertRuleType.java              # 预警规则类型枚举
│   │   └── AlertTriggerCondition.java      # 预警触发条件实体
│   └── repository/
│       └── AlertRuleRepository.java        # 预警规则仓库接口
├── infrastructure/
│   ├── repository/impl/
│   │   └── AlertRuleRepositoryImpl.java    # 预警规则仓库实现
│   ├── persistence/
│   │   ├── entity/
│   │   │   └── AlertRuleEntity.java        # 预警规则数据库实体
│   │   └── mapper/
│   │       └── AlertRuleMapper.java        # 预警规则MyBatis映射器
│   └── config/
│       └── AlertRuleConfig.java            # 预警规则配置类
└── common/
    └── constant/
        └── AlertConstants.java             # 预警相关常量
```

### 预警规则设计
根据 [Source: architecture/8.core-workflows.md#证书预警工作流]：

**预警规则基本配置：**
```java
public class AlertRule {
    private Long id;
    private String name;                    // 规则名称
    private AlertRuleType type;             // 规则类型（TIME_BASED）
    private Integer daysBefore;             // 提前多少天预警
    private AlertTriggerCondition condition; // 触发条件
    private Integer priority;               // 优先级（数字越小优先级越高）
    private Boolean enabled;                // 是否启用
    private List<String> alertChannels;    // 预警渠道（EMAIL、SMS）
    private Date createdAt;
    private Date updatedAt;
}

public enum AlertRuleType {
    TIME_BASED,      // 基于时间的规则
    STATUS_CHANGE,   // 基于状态变更的规则
    CUSTOM          // 自定义规则
}
```

**默认预警规则：**
1. 30天预警规则：证书30天内到期时发送邮件预警
2. 15天预警规则：证书15天内到期时发送邮件预警
3. 7天预警规则：证书7天内到期时发送邮件和短信预警
4. 1天预警规则：证书1天内到期时发送邮件和短信预警

### 规则引擎设计
根据 [Source: architecture/11.backend-architecture.md#设计模式]：

**规则引擎接口：**
```java
public interface AlertRuleEngine {
    /**
     * 评估证书是否触发预警规则
     * @param certificate 证书信息
     * @return 是否触发预警
     */
    boolean evaluateRules(Certificate certificate);
    
    /**
     * 获取被触发的预警规则列表
     * @param certificate 证书信息
     * @return 被触发的规则列表
     */
    List<AlertRule> getTriggeredRules(Certificate certificate);
    
    /**
     * 根据优先级获取最高优先级的规则
     * @param rules 规则列表
     * @return 最高优先级的规则
     */
    AlertRule getHighestPriorityRule(List<AlertRule> rules);
}
```

**规则评估逻辑：**
```java
public class AlertRuleEngineImpl implements AlertRuleEngine {
    @Override
    public boolean evaluateRules(Certificate certificate) {
        List<AlertRule> allRules = alertRuleConfigService.getEnabledRules();
        
        for (AlertRule rule : allRules) {
            if (evaluateRule(rule, certificate)) {
                return true;
            }
        }
        return false;
    }
    
    private boolean evaluateRule(AlertRule rule, Certificate certificate) {
        int daysUntilExpiry = calculateDaysUntilExpiry(certificate);
        
        switch (rule.getType()) {
            case TIME_BASED:
                return daysUntilExpiry <= rule.getDaysBefore() && daysUntilExpiry >= 0;
            case STATUS_CHANGE:
                return hasStatusChanged(certificate);
            default:
                return false;
        }
    }
}
```

### 集成到监控服务
根据 [Source: architecture/8.core-workflows.md#自动监控工作流]：

**监控服务集成：**
```java
@Service
public class MonitoringServiceImpl implements MonitoringService {
    private final AlertRuleEngine alertRuleEngine;
    
    @Override
    public void monitorCertificate(Certificate certificate) {
        // 现有监控逻辑...
        
        // 评估预警规则
        if (alertRuleEngine.evaluateRules(certificate)) {
            List<AlertRule> triggeredRules = alertRuleEngine.getTriggeredRules(certificate);
            
            for (AlertRule rule : triggeredRules) {
                // 发送预警（当前阶段仅记录日志）
                sendAlert(certificate, rule);
            }
        }
        
        // 记录监控日志...
    }
    
    private void sendAlert(Certificate certificate, AlertRule rule) {
        // MVP阶段仅记录日志，不实际发送预警
        log.info("预警触发 - 证书: {}, 规则: {}, 剩余天数: {}", 
                certificate.getName(), rule.getName(), 
                calculateDaysUntilExpiry(certificate));
                
        // 记录预警日志
        monitoringLogService.logAlert(certificate, rule);
    }
}
```

### 配置管理
根据 [Source: architecture/11.backend-architecture.md#配置类]：

**配置服务设计：**
```java
@Service
public class AlertRuleConfigServiceImpl implements AlertRuleConfigService {
    @Value("${alert.rules.default.enabled:true}")
    private boolean defaultRulesEnabled;
    
    @Override
    public List<AlertRule> getEnabledRules() {
        // 从配置或数据库加载规则
        List<AlertRule> rules = loadRulesFromConfig();
        return rules.stream()
                   .filter(AlertRule::getEnabled)
                   .sorted(Comparator.comparing(AlertRule::getPriority))
                   .collect(Collectors.toList());
    }
    
    @Override
    public void initializeDefaultRules() {
        // 初始化默认预警规则
        createDefaultRule("30天预警", TIME_BASED, 30, Arrays.asList("EMAIL"), 1);
        createDefaultRule("15天预警", TIME_BASED, 15, Arrays.asList("EMAIL"), 2);
        createDefaultRule("7天预警", TIME_BASED, 7, Arrays.asList("EMAIL", "SMS"), 3);
        createDefaultRule("1天预警", TIME_BASED, 1, Arrays.asList("EMAIL", "SMS"), 4);
    }
}
```

### 数据模型扩展
根据 [Source: architecture/4.data-models.md]：

**预警规则数据库表结构：**
```sql
CREATE TABLE alert_rules (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL,
    days_before INT,
    priority INT NOT NULL,
    enabled BOOLEAN DEFAULT TRUE,
    alert_channels JSON,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_type_enabled (type, enabled),
    INDEX idx_priority (priority)
);
```

### 错误处理策略
根据 [Source: architecture/18.error-handling-strategy.md]：

**规则引擎异常处理：**
```java
public class AlertRuleException extends RuntimeException {
    private String ruleId;
    private String certificateId;
    
    public AlertRuleException(String message, String ruleId, String certificateId) {
        super(message);
        this.ruleId = ruleId;
        this.certificateId = certificateId;
    }
}

// 在规则引擎中的异常处理
try {
    return evaluateRule(rule, certificate);
} catch (Exception e) {
    log.error("规则评估失败 - 规则ID: {}, 证书ID: {}, 错误: {}", 
             rule.getId(), certificate.getId(), e.getMessage());
    throw new AlertRuleException("规则评估失败", 
                                rule.getId().toString(), 
                                certificate.getId().toString());
}
```

### 编码规范
根据 [Source: architecture/17.coding-standards.md]：

**命名规范：**
- 类名: PascalCase (如 `AlertRuleEngine`)
- 方法/变量: camelCase (如 `evaluateRules`)
- 常量: UPPER_SNAKE_CASE (如 `DEFAULT_PRIORITY`)
- 数据库表: snake_case (如 `alert_rules`)

**关键规则：**
- 使用构造函数注入依赖
- 接口与实现分离
- 每个方法都要有适当的日志记录
- 使用 @Transactional 管理事务

## Testing
根据 [Source: architecture/16.testing-strategy.md#后端测试]：

**测试标准：**
- 使用 JUnit 5 作为测试框架
- 使用 Mockito 进行依赖模拟
- 测试文件位置：`backend/src/test/java/com/example/certificate/`
- 测试命名：`XxxTest.java`
- 测试方法命名：`testMethodName_scenario_expectedResult()`
- 覆盖率目标：核心业务逻辑 80%+

**测试示例：**
```java
@ExtendWith(MockitoExtension.class)
class AlertRuleEngineTest {
    @Mock
    private AlertRuleConfigService alertRuleConfigService;
    
    @InjectMocks
    private AlertRuleEngineImpl alertRuleEngine;
    
    @Test
    void testEvaluateRules_30DaysRule_shouldTrigger() {
        // Given
        Certificate certificate = createCertificate(25); // 25天后到期
        AlertRule rule30Days = createTimeBasedRule("30天预警", 30);
        when(alertRuleConfigService.getEnabledRules()).thenReturn(Arrays.asList(rule30Days));
        
        // When
        boolean result = alertRuleEngine.evaluateRules(certificate);
        
        // Then
        assertTrue(result);
    }
    
    @Test
    void testGetTriggeredRules_multipleRules_shouldReturnTriggered() {
        // Given
        Certificate certificate = createCertificate(5); // 5天后到期
        List<AlertRule> rules = Arrays.asList(
            createTimeBasedRule("30天预警", 30),
            createTimeBasedRule("15天预警", 15),
            createTimeBasedRule("7天预警", 7),
            createTimeBasedRule("1天预警", 1)
        );
        when(alertRuleConfigService.getEnabledRules()).thenReturn(rules);
        
        // When
        List<AlertRule> triggeredRules = alertRuleEngine.getTriggeredRules(certificate);
        
        // Then
        assertEquals(3, triggeredRules.size()); // 30天、15天、7天规则应该被触发
        assertTrue(triggeredRules.stream().anyMatch(r -> r.getName().equals("30天预警")));
        assertTrue(triggeredRules.stream().anyMatch(r -> r.getName().equals("15天预警")));
        assertTrue(triggeredRules.stream().anyMatch(r -> r.getName().equals("7天预警")));
        assertFalse(triggeredRules.stream().anyMatch(r -> r.getName().equals("1天预警")));
    }
}
```

**运行测试命令：**
```bash
cd backend
mvn test -Dtest=AlertRuleEngineTest
mvn test -Dtest=AlertRuleConfigServiceTest
mvn test # 运行所有测试
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-16 | 1.0 | 初始故事创建 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
无严重错误，所有测试通过

### Completion Notes
1. **预警规则数据模型**：完成了 AlertRule、AlertRuleType、AlertTriggerCondition 的完整实现，包含业务验证逻辑
2. **预警规则引擎**：实现了 AlertRuleEngine 接口和 AlertRuleEngineImpl 实现类，支持规则评估、优先级处理和多规则触发
3. **预警规则配置服务**：实现了 AlertRuleConfigService 接口和实现类，包含默认规则初始化、缓存机制和验证逻辑
4. **监控服务集成**：成功将预警规则引擎集成到 MonitoringServiceImpl 中，实现了预警触发和日志记录
5. **测试覆盖**：编写了完整的单元测试和集成测试，覆盖了所有核心功能和边界情况
6. **功能验证**：通过集成测试验证了 30天、15天、7天、1天预警规则的准确性，以及规则优先级和多规则触发场景

### File List
#### 新增文件
- `backend/src/main/java/com/example/certificate/domain/model/AlertRule.java` - 预警规则实体类
- `backend/src/main/java/com/example/certificate/domain/model/AlertRuleType.java` - 预警规则类型枚举
- `backend/src/main/java/com/example/certificate/domain/model/AlertTriggerCondition.java` - 预警触发条件实体类
- `backend/src/main/java/com/example/certificate/service/AlertRuleEngine.java` - 预警规则引擎接口
- `backend/src/main/java/com/example/certificate/service/impl/AlertRuleEngineImpl.java` - 预警规则引擎实现类
- `backend/src/main/java/com/example/certificate/service/AlertRuleConfigService.java` - 预警规则配置服务接口
- `backend/src/main/java/com/example/certificate/service/impl/AlertRuleConfigServiceImpl.java` - 预警规则配置服务实现类
- `backend/src/test/java/com/example/certificate/service/AlertRuleEngineTest.java` - 预警规则引擎单元测试
- `backend/src/test/java/com/example/certificate/service/AlertRuleConfigServiceTest.java` - 预警规则配置服务单元测试
- `backend/src/test/java/com/example/certificate/service/AlertRuleIntegrationTest.java` - 预警规则集成测试

#### 修改文件
- `backend/src/main/java/com/example/certificate/service/impl/MonitoringServiceImpl.java` - 集成预警规则引擎，添加预警触发逻辑
- `backend/src/test/java/com/example/certificate/service/MonitoringServiceFunctionalTest.java` - 添加 AlertRuleEngine Mock
- `backend/src/test/java/com/example/certificate/service/MonitoringServiceIntegrationTest.java` - 添加 AlertRuleEngine Mock
- `backend/src/test/java/com/example/certificate/service/MonitoringServiceTest.java` - 添加 AlertRuleEngine Mock

## QA Results
（待QA审查时填写）