# Story 1.3: 核心证书管理API

## Status
Draft

## Story
**As a** 后端开发人员,
**I want** 实现证书管理的核心API,
**so that** 提供证书数据的基本操作功能.

## Acceptance Criteria
1. 实现证书信息创建API，支持添加新证书
2. 实现证书信息读取API，支持查询单个和多个证书
3. 实现证书信息更新API，支持修改证书信息
4. 实现证书信息删除API，支持删除证书记录
5. 实现证书列表查询API，支持基本的分页和排序
6. 添加基本的API输入验证
7. 添加基本的错误处理机制
8. 编写API的单元测试

## Tasks / Subtasks
- [ ] Task 1: 创建通用响应和异常处理框架 (AC: 6, 7)
  - [ ] Subtask 1.1: 在 `backend/src/main/java/com/example/certificate/common/response/` 创建 ApiResponse.java 统一响应类
  - [ ] Subtask 1.2: 创建 ApiError.java 错误响应类，定义错误代码和消息
  - [ ] Subtask 1.3: 在 `backend/src/main/java/com/example/certificate/common/exception/` 创建 BusinessException.java 业务异常类
  - [ ] Subtask 1.4: 创建 GlobalExceptionHandler.java 全局异常处理器，使用 @RestControllerAdvice
  - [ ] Subtask 1.5: 定义 ErrorCode 枚举类，包含所有错误代码（10001-证书不存在，10002-证书验证失败等）

- [ ] Task 2: 创建证书服务层接口和实现 (AC: 1, 2, 3, 4, 5)
  - [ ] Subtask 2.1: 在 `backend/src/main/java/com/example/certificate/service/` 创建 CertificateService.java 接口
  - [ ] Subtask 2.2: 定义服务方法：createCertificate, getCertificateById, updateCertificate, deleteCertificate, getCertificateList
  - [ ] Subtask 2.3: 在 `backend/src/main/java/com/example/certificate/service/impl/` 创建 CertificateServiceImpl.java 实现类
  - [ ] Subtask 2.4: 实现所有服务方法，注入 CertificateRepository，添加 @Service 和 @Transactional 注解
  - [ ] Subtask 2.5: 在服务方法中添加业务逻辑验证（如域名唯一性检查）
  - [ ] Subtask 2.6: 实现分页查询逻辑，使用 MyBatis Plus 的 Page 类

- [ ] Task 3: 创建证书控制器实现 REST API (AC: 1, 2, 3, 4, 5)
  - [ ] Subtask 3.1: 在 `backend/src/main/java/com/example/certificate/controller/` 创建 CertificateController.java
  - [ ] Subtask 3.2: 添加 @RestController 和 @RequestMapping("/api/v1/certificates") 注解
  - [ ] Subtask 3.3: 实现 POST / 端点创建证书，使用 @PostMapping 和 @Valid @RequestBody
  - [ ] Subtask 3.4: 实现 GET /{id} 端点获取单个证书，使用 @GetMapping 和 @PathVariable
  - [ ] Subtask 3.5: 实现 GET / 端点获取证书列表，支持分页参数 @RequestParam
  - [ ] Subtask 3.6: 实现 PUT /{id} 端点更新证书，使用 @PutMapping
  - [ ] Subtask 3.7: 实现 DELETE /{id} 端点删除证书，使用 @DeleteMapping

- [ ] Task 4: 创建分页和查询请求对象 (AC: 5)
  - [ ] Subtask 4.1: 在 `backend/src/main/java/com/example/certificate/controller/request/` 创建 PageRequest.java 基础分页请求类
  - [ ] Subtask 4.2: 定义分页参数：pageNum (默认1), pageSize (默认10), sortBy, sortOrder
  - [ ] Subtask 4.3: 创建 CertificateQueryRequest.java 继承 PageRequest，添加筛选字段
  - [ ] Subtask 4.4: 添加筛选参数：status, domain, issuer, expiryDateFrom, expiryDateTo
  - [ ] Subtask 4.5: 添加 JSR-303 验证注解，如 @Min, @Max 限制分页大小

- [ ] Task 5: 增强 DTO 对象和验证 (AC: 6)
  - [ ] Subtask 5.1: 在 CertificateCreateDto.java 中添加完整的验证注解
  - [ ] Subtask 5.2: 使用 @NotBlank 验证 name, domain, issuer, certificateType
  - [ ] Subtask 5.3: 使用 @NotNull 验证 issueDate, expiryDate
  - [ ] Subtask 5.4: 使用 @Pattern 验证 domain 格式（域名正则表达式）
  - [ ] Subtask 5.5: 在 CertificateUpdateDto.java 中添加相应的验证规则
  - [ ] Subtask 5.6: 创建自定义验证注解 @ValidDateRange 确保 issueDate < expiryDate

- [ ] Task 6: 实现对象转换器 (AC: 1, 2, 3)
  - [ ] Subtask 6.1: 在 `backend/src/main/java/com/example/certificate/service/converter/` 创建 CertificateConverter.java
  - [ ] Subtask 6.2: 实现 CreateDto 到 Domain 模型的转换方法
  - [ ] Subtask 6.3: 实现 Domain 模型到 Dto 的转换方法
  - [ ] Subtask 6.4: 实现 UpdateDto 到 Domain 模型的合并方法
  - [ ] Subtask 6.5: 添加 @Component 注解，使其成为 Spring 管理的 Bean

- [ ] Task 7: 配置 Spring Boot 应用设置 (AC: 7)
  - [ ] Subtask 7.1: 在 application.yml 中配置 Jackson 日期格式化
  - [ ] Subtask 7.2: 配置全局时区为 UTC
  - [ ] Subtask 7.3: 配置 MyBatis Plus 分页插件
  - [ ] Subtask 7.4: 配置 Spring Validation 错误消息
  - [ ] Subtask 7.5: 配置 API 文档生成（SpringDoc OpenAPI）

- [ ] Task 8: 编写控制器单元测试 (AC: 8)
  - [ ] Subtask 8.1: 在 `backend/src/test/java/com/example/certificate/controller/` 创建 CertificateControllerTest.java
  - [ ] Subtask 8.2: 使用 @WebMvcTest 注解配置测试环境
  - [ ] Subtask 8.3: 使用 @MockBean 模拟 CertificateService
  - [ ] Subtask 8.4: 测试 POST 创建证书端点的成功和验证失败场景
  - [ ] Subtask 8.5: 测试 GET 获取单个证书端点的成功和404场景
  - [ ] Subtask 8.6: 测试 GET 获取证书列表端点的分页功能
  - [ ] Subtask 8.7: 测试 PUT 更新证书端点的各种场景
  - [ ] Subtask 8.8: 测试 DELETE 删除证书端点的成功和失败场景

- [ ] Task 9: 编写服务层单元测试 (AC: 8)
  - [ ] Subtask 9.1: 在 `backend/src/test/java/com/example/certificate/service/` 创建 CertificateServiceTest.java
  - [ ] Subtask 9.2: 使用 @ExtendWith(MockitoExtension.class) 配置 Mockito
  - [ ] Subtask 9.3: 使用 @Mock 注解模拟 CertificateRepository
  - [ ] Subtask 9.4: 测试创建证书的业务逻辑，包括域名重复检查
  - [ ] Subtask 9.5: 测试更新证书的各种场景
  - [ ] Subtask 9.6: 测试分页查询的排序和筛选功能
  - [ ] Subtask 9.7: 测试异常处理和事务回滚

## Dev Notes

### 前一个故事的关键信息
基于 [Source: docs/stories/1.2.story.md#Dev Agent Record]：
- 数据模型已完成，包括 Certificate 和 MonitoringLog 实体
- 仓库层已实现，包括 CertificateRepository 接口和实现类
- MyBatis 映射器已配置，支持基本 CRUD 和自定义查询
- DTO 对象已创建：CertificateDto, CertificateCreateDto, CertificateUpdateDto
- 数据库表已创建，包含索引和约束
- Certificate 领域模型包含业务逻辑方法（calculateStatus, isExpired, isExpiringSoon）
- 已实现 CertificateConverter 用于对象转换

### API 端点规范
根据 [Source: architecture/api-specs.md#证书管理接口]：

**核心 REST API 端点：**
- `POST /api/v1/certificates` - 创建新证书
- `GET /api/v1/certificates/{id}` - 获取证书详情
- `GET /api/v1/certificates` - 获取证书列表（支持分页）
- `PUT /api/v1/certificates/{id}` - 更新证书信息
- `DELETE /api/v1/certificates/{id}` - 删除证书

**统一响应格式：**
```java
public class ApiResponse<T> {
    private boolean success;
    private int code;
    private String message;
    private T data;
    private String timestamp;
}
```

**错误响应格式：**
```java
public class ApiError {
    private boolean success; // 始终为 false
    private int code;
    private String message;
    private String error;
    private String timestamp;
}
```

### 请求参数规范
根据 [Source: architecture/api-specs.md#请求参数]：

**分页参数：**
- pageNum: 页码，默认 1
- pageSize: 每页大小，默认 10，最大 100
- sortBy: 排序字段（name, domain, expiryDate, createdAt）
- sortOrder: 排序方向（ASC, DESC）

**筛选参数：**
- status: 证书状态（NORMAL, EXPIRING_SOON, EXPIRED）
- domain: 域名（支持模糊搜索）
- issuer: 颁发机构
- expiryDateFrom/To: 到期日期范围

### 验证规则
根据 [Source: architecture/backend-architecture.md#数据验证]：

**输入验证（使用 JSR-303）：**
- @NotBlank: name, domain, issuer, certificateType
- @NotNull: issueDate, expiryDate
- @Size(max = 100): name, issuer
- @Size(max = 255): domain
- @Size(max = 50): certificateType
- @Pattern: domain 格式验证（域名正则）

**业务验证：**
- 域名唯一性检查（创建时）
- 日期逻辑验证（issueDate < expiryDate）
- 证书存在性验证（更新/删除时）

### 错误处理
根据 [Source: architecture/error-handling-strategy.md]：

**错误代码定义：**
- 200: 成功
- 400: 请求参数错误
- 401: 未授权访问
- 404: 资源不存在
- 500: 服务器内部错误
- 10001: 证书不存在
- 10002: 证书验证失败
- 10003: 域名已存在

**全局异常处理：**
- 使用 @RestControllerAdvice 实现全局异常处理
- 捕获 BusinessException 返回业务错误
- 捕获 MethodArgumentNotValidException 返回验证错误
- 捕获 Exception 返回通用错误

### 技术栈配置
根据 [Source: architecture/tech-stack.md#后端技术栈]：

**Spring Boot 配置：**
- Spring Boot 2.7.18
- Spring Web MVC
- Spring Validation
- Spring Transaction

**MyBatis Plus 配置：**
- MyBatis Plus 3.5.3.1
- 分页插件配置
- 逻辑删除配置（如需要）

**依赖注入：**
- 构造函数注入优先
- 使用 @Service, @Controller, @Component 注解
- 使用 @Transactional 管理事务

### 文件位置指导
根据 [Source: architecture/unified-project-structure.md#后端结构]：

**控制器层：**
- 位置：`backend/src/main/java/com/example/certificate/controller/`
- 文件：CertificateController.java

**服务层：**
- 接口：`backend/src/main/java/com/example/certificate/service/CertificateService.java`
- 实现：`backend/src/main/java/com/example/certificate/service/impl/CertificateServiceImpl.java`
- 转换器：`backend/src/main/java/com/example/certificate/service/converter/CertificateConverter.java`

**通用模块：**
- 响应：`backend/src/main/java/com/example/certificate/common/response/`
- 异常：`backend/src/main/java/com/example/certificate/common/exception/`

**请求对象：**
- 位置：`backend/src/main/java/com/example/certificate/controller/request/`

### 测试要求
根据 [Source: architecture/testing-strategy.md#后端测试]：

**单元测试框架：**
- JUnit 5.8.x
- Mockito 4.5.x
- Spring Boot Test 2.7.x

**测试注解：**
- @WebMvcTest - 控制器测试
- @ExtendWith(MockitoExtension.class) - 服务层测试
- @MockBean - Spring 上下文中的 Mock
- @Mock - 纯 Mockito Mock

**测试覆盖要求：**
- 控制器层：所有端点的成功和失败场景
- 服务层：核心业务逻辑和异常处理
- 验证测试：输入验证和业务规则验证

**测试文件位置：**
- 控制器测试：`backend/src/test/java/com/example/certificate/controller/`
- 服务测试：`backend/src/test/java/com/example/certificate/service/`

### 开发提示
- 充分利用已实现的 CertificateRepository 和领域模型
- 使用已存在的 DTO 对象，避免重复创建
- 确保所有 API 返回统一的响应格式
- 在服务层处理业务逻辑，控制器层只负责请求响应
- 使用 @Transactional 确保数据一致性
- 充分测试边界条件和异常场景

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-15 | 1.0 | 初始故事创建 | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results