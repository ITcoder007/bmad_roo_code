# Story 3.4: 简化仪表板

## Status
Draft

## Story
**As a** 前端开发人员,
**I want** 实现简化的系统仪表板,
**so that** 用户能够快速了解系统的基本状态.

## Acceptance Criteria
1. 实现仪表板页面，展示证书总数和状态分布
2. 添加简单的数字和颜色标识展示证书状态分布（正常、即将过期、已过期）
3. 展示即将过期证书的列表（7天内到期）
4. 展示最近添加的证书列表
5. 添加快速导航到证书列表的入口
6. 确保仪表板在桌面浏览器上的基本响应式布局
7. 添加仪表板数据的自动刷新功能（每5分钟）

## Tasks / Subtasks

- [ ] Task 1: 创建仪表板页面基础结构 (AC: 1, 6)
  - [ ] Subtask 1.1: 在 `frontend/src/views/monitoring/Dashboard.vue` 中创建仪表板页面
  - [ ] Subtask 1.2: 使用 Element Plus Grid 布局系统实现响应式设计
  - [ ] Subtask 1.3: 创建仪表板基础页面结构和导航集成
  - [ ] Subtask 1.4: 配置路由，确保仪表板作为默认首页

- [ ] Task 2: 实现证书状态统计显示 (AC: 1, 2)
  - [ ] Subtask 2.1: 创建 `CertificateStatsCard.vue` 组件显示证书总数和分布
  - [ ] Subtask 2.2: 使用 ECharts 饼图显示证书状态分布
  - [ ] Subtask 2.3: 实现状态数字展示，使用颜色标识（绿色-正常，橙色-即将过期，红色-已过期）
  - [ ] Subtask 2.4: 添加数据获取逻辑，从证书 store 计算统计信息

- [ ] Task 3: 实现即将过期证书列表 (AC: 3, 5)
  - [ ] Subtask 3.1: 创建 `ExpiringCertificatesList.vue` 组件
  - [ ] Subtask 3.2: 实现筛选逻辑，显示7天内到期的证书
  - [ ] Subtask 3.3: 使用 Element Plus Table 组件展示证书基本信息
  - [ ] Subtask 3.4: 添加快速导航到证书详情和证书列表页面的链接

- [ ] Task 4: 实现最近添加证书列表 (AC: 4, 5)
  - [ ] Subtask 4.1: 创建 `RecentCertificatesList.vue` 组件
  - [ ] Subtask 4.2: 实现按创建时间排序，显示最近5个证书
  - [ ] Subtask 4.3: 集成证书状态标识和基本信息展示
  - [ ] Subtask 4.4: 添加快速导航功能

- [ ] Task 5: 实现数据自动刷新机制 (AC: 7)
  - [ ] Subtask 5.1: 创建 `useAutoRefresh.js` 组合函数
  - [ ] Subtask 5.2: 实现每5分钟自动刷新仪表板数据
  - [ ] Subtask 5.3: 添加手动刷新按钮和刷新状态指示器
  - [ ] Subtask 5.4: 实现页面可见性检测，避免隐藏时刷新

- [ ] Task 6: 扩展状态管理和API接口 (AC: 1, 2, 3, 4)
  - [ ] Subtask 6.1: 在 `certificate.js` store 中添加 `fetchDashboardStats` action
  - [ ] Subtask 6.2: 在 `certificate.js` API 中实现 `getDashboardStats` 接口
  - [ ] Subtask 6.3: 添加统计信息的状态管理（总数、分布、即将过期列表）
  - [ ] Subtask 6.4: 实现缓存机制，避免频繁API调用

- [ ] Task 7: 编写测试用例 (AC: 1-7)
  - [ ] Subtask 7.1: 创建 `frontend/tests/unit/views/monitoring/Dashboard.spec.js` 测试文件
  - [ ] Subtask 7.2: 编写仪表板页面渲染和数据展示的测试用例
  - [ ] Subtask 7.3: 编写统计组件和图表显示的测试用例
  - [ ] Subtask 7.4: 编写即将过期和最近添加证书列表的测试用例
  - [ ] Subtask 7.5: 编写自动刷新功能的测试用例
  - [ ] Subtask 7.6: 编写状态管理和API调用的集成测试

## Dev Notes

### 前一个故事的关键信息
基于 [Source: docs/stories/3.3.story.md#Dev Agent Record]：
- 证书搜索功能已完成，包含完整的搜索和高亮显示
- CertificateSearchBox 组件已实现，可在仪表板中复用
- 证书状态管理(certificate store)已完善，支持搜索和状态计算
- 高亮工具函数和防抖功能已可用
- 完整的测试框架已建立，覆盖组件和工具函数测试

### 技术栈配置
根据 [Source: architecture/3.tech-stack.md]：

**前端技术栈（必须使用）：**
- Vue.js 3.x - 响应式用户界面框架
- Vue Router 4.x - 前端路由管理
- Pinia 2.x - 状态管理
- Element Plus 2.x - UI 组件库
- ECharts 5.x - 数据可视化（仪表板图表）
- Vite 4.x - 构建工具
- JavaScript ES2020+ - 开发语言
- Vitest 1.x + Vue Test Utils 2.x - 测试框架

### 项目结构
根据 [Source: architecture/12.unified-project-structure.md]：

**仪表板功能相关文件位置：**
```
frontend/src/
├── views/monitoring/
│   └── Dashboard.vue                     # 仪表板页面（本故事主要文件）
├── components/business/
│   ├── CertificateStatsCard.vue          # 证书统计卡片组件（新建）
│   ├── ExpiringCertificatesList.vue      # 即将过期证书列表组件（新建）
│   ├── RecentCertificatesList.vue        # 最近添加证书列表组件（新建）
│   └── CertificateStatusBadge.vue        # 证书状态徽章组件（已存在，可复用）
├── stores/modules/
│   └── certificate.js                    # 证书状态管理（已存在，需扩展统计功能）
├── api/
│   └── certificate.js                    # 证书API接口（已存在，需扩展统计接口）
├── composables/
│   ├── useAutoRefresh.js                 # 自动刷新组合函数（新建）
│   └── useDebounce.js                    # 防抖组合函数（已存在）
└── router/modules/
    └── monitoring.js                     # 监控路由模块（已存在）
```

### 前端架构设计
根据 [Source: architecture/10.frontend-architecture.md]：

**Vue 3 组合式API仪表板设计：**
```javascript
// Dashboard.vue 组件结构示例
<template>
  <div class="dashboard">
    <div class="page-header">
      <h1>系统仪表板</h1>
      <div class="header-actions">
        <el-button :icon="Refresh" @click="handleRefresh" :loading="refreshing">
          刷新数据
        </el-button>
        <span class="last-update">最后更新: {{ lastUpdateTime }}</span>
      </div>
    </div>
    
    <!-- 统计卡片区域 -->
    <el-row :gutter="20" class="stats-row">
      <el-col :xs="24" :sm="12" :md="6" :lg="6">
        <CertificateStatsCard 
          :stats="certificateStats" 
          :loading="statsLoading" 
        />
      </el-col>
    </el-row>
    
    <!-- 主要内容区域 -->
    <el-row :gutter="20" class="content-row">
      <!-- 即将过期证书 -->
      <el-col :xs="24" :md="12">
        <el-card>
          <template #header>
            <div class="card-header">
              <span>即将过期证书 (7天内)</span>
              <router-link to="/certificates?filter=expiring">
                <el-button text type="primary">查看全部</el-button>
              </router-link>
            </div>
          </template>
          <ExpiringCertificatesList 
            :certificates="expiringCertificates" 
            :loading="certificatesLoading" 
          />
        </el-card>
      </el-col>
      
      <!-- 最近添加证书 -->
      <el-col :xs="24" :md="12">
        <el-card>
          <template #header>
            <div class="card-header">
              <span>最近添加证书</span>
              <router-link to="/certificates">
                <el-button text type="primary">查看全部</el-button>
              </router-link>
            </div>
          </template>
          <RecentCertificatesList 
            :certificates="recentCertificates" 
            :loading="certificatesLoading" 
          />
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue'
import { Refresh } from '@element-plus/icons-vue'
import { useCertificateStore } from '@/stores/modules/certificate'
import { useAutoRefresh } from '@/composables/useAutoRefresh'
import CertificateStatsCard from '@/components/business/CertificateStatsCard.vue'
import ExpiringCertificatesList from '@/components/business/ExpiringCertificatesList.vue'
import RecentCertificatesList from '@/components/business/RecentCertificatesList.vue'

// 状态管理
const certificateStore = useCertificateStore()

// 响应式数据
const refreshing = ref(false)
const lastUpdateTime = ref('')

// 计算属性
const certificateStats = computed(() => certificateStore.dashboardStats)
const expiringCertificates = computed(() => certificateStore.expiringCertificates)
const recentCertificates = computed(() => certificateStore.recentCertificates)
const statsLoading = computed(() => certificateStore.loading)
const certificatesLoading = computed(() => certificateStore.loading)

// 自动刷新
const { startAutoRefresh, stopAutoRefresh } = useAutoRefresh(() => {
  fetchDashboardData()
}, 5 * 60 * 1000) // 5分钟

// 方法
const fetchDashboardData = async () => {
  try {
    await Promise.all([
      certificateStore.fetchDashboardStats(),
      certificateStore.fetchExpiringCertificates(7),
      certificateStore.fetchRecentCertificates(5)
    ])
    lastUpdateTime.value = new Date().toLocaleTimeString()
  } catch (error) {
    console.error('获取仪表板数据失败:', error)
  }
}

const handleRefresh = async () => {
  refreshing.value = true
  try {
    await fetchDashboardData()
  } finally {
    refreshing.value = false
  }
}

// 生命周期
onMounted(() => {
  fetchDashboardData()
  startAutoRefresh()
})

onUnmounted(() => {
  stopAutoRefresh()
})
</script>

<style scoped>
.dashboard {
  padding: 20px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 16px;
}

.last-update {
  color: #909399;
  font-size: 12px;
}

.stats-row {
  margin-bottom: 20px;
}

.content-row .el-card {
  height: 400px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

@media (max-width: 768px) {
  .dashboard {
    padding: 10px;
  }
  
  .page-header {
    flex-direction: column;
    align-items: stretch;
    gap: 10px;
  }
  
  .header-actions {
    justify-content: space-between;
  }
}
</style>
```

### 证书统计卡片组件设计
```javascript
// CertificateStatsCard.vue 组件设计
<template>
  <el-card class="stats-card">
    <div class="stats-header">
      <h3>证书概览</h3>
      <el-icon class="stats-icon"><Document /></el-icon>
    </div>
    
    <div v-if="loading" class="loading-container">
      <el-skeleton :rows="3" animated />
    </div>
    
    <div v-else class="stats-content">
      <!-- 总数显示 -->
      <div class="total-count">
        <span class="count-number">{{ stats.total || 0 }}</span>
        <span class="count-label">证书总数</span>
      </div>
      
      <!-- 状态分布 -->
      <div class="status-distribution">
        <div class="status-item status-normal">
          <span class="status-count">{{ stats.normal || 0 }}</span>
          <span class="status-label">正常</span>
        </div>
        <div class="status-item status-expiring">
          <span class="status-count">{{ stats.expiring || 0 }}</span>
          <span class="status-label">即将过期</span>
        </div>
        <div class="status-item status-expired">
          <span class="status-count">{{ stats.expired || 0 }}</span>
          <span class="status-label">已过期</span>
        </div>
      </div>
      
      <!-- ECharts 饼图 -->
      <div ref="chartRef" class="chart-container"></div>
    </div>
  </el-card>
</template>

<script setup>
import { ref, computed, watch, onMounted, nextTick } from 'vue'
import { Document } from '@element-plus/icons-vue'
import * as echarts from 'echarts'

// Props
const props = defineProps({
  stats: {
    type: Object,
    default: () => ({})
  },
  loading: {
    type: Boolean,
    default: false
  }
})

// 响应式数据
const chartRef = ref(null)
let chartInstance = null

// 计算属性
const chartData = computed(() => [
  { name: '正常', value: props.stats.normal || 0, color: '#67C23A' },
  { name: '即将过期', value: props.stats.expiring || 0, color: '#E6A23C' },
  { name: '已过期', value: props.stats.expired || 0, color: '#F56C6C' }
])

// 方法
const initChart = () => {
  if (!chartRef.value) return
  
  chartInstance = echarts.init(chartRef.value)
  updateChart()
}

const updateChart = () => {
  if (!chartInstance) return
  
  const option = {
    tooltip: {
      trigger: 'item',
      formatter: '{a} <br/>{b}: {c} ({d}%)'
    },
    series: [
      {
        name: '证书状态分布',
        type: 'pie',
        radius: ['40%', '70%'],
        center: ['50%', '50%'],
        data: chartData.value,
        emphasis: {
          itemStyle: {
            shadowBlur: 10,
            shadowOffsetX: 0,
            shadowColor: 'rgba(0, 0, 0, 0.5)'
          }
        },
        itemStyle: {
          color: params => params.data.color
        }
      }
    ]
  }
  
  chartInstance.setOption(option)
}

const resizeChart = () => {
  if (chartInstance) {
    chartInstance.resize()
  }
}

// 监听器
watch(() => props.stats, () => {
  nextTick(() => updateChart())
}, { deep: true })

// 生命周期
onMounted(() => {
  nextTick(() => initChart())
  window.addEventListener('resize', resizeChart)
})
</script>

<style scoped>
.stats-card {
  height: 100%;
}

.stats-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.stats-icon {
  font-size: 24px;
  color: #409eff;
}

.loading-container {
  padding: 20px 0;
}

.total-count {
  text-align: center;
  margin-bottom: 20px;
}

.count-number {
  display: block;
  font-size: 32px;
  font-weight: bold;
  color: #409eff;
}

.count-label {
  display: block;
  font-size: 14px;
  color: #909399;
  margin-top: 5px;
}

.status-distribution {
  display: flex;
  justify-content: space-around;
  margin-bottom: 20px;
}

.status-item {
  text-align: center;
}

.status-count {
  display: block;
  font-size: 18px;
  font-weight: bold;
}

.status-label {
  display: block;
  font-size: 12px;
  margin-top: 2px;
}

.status-normal .status-count {
  color: #67C23A;
}

.status-expiring .status-count {
  color: #E6A23C;
}

.status-expired .status-count {
  color: #F56C6C;
}

.chart-container {
  height: 200px;
  width: 100%;
}
</style>
```

### 自动刷新组合函数设计
```javascript
// useAutoRefresh.js 组合函数
import { ref, onUnmounted } from 'vue'

export function useAutoRefresh(callback, interval = 5 * 60 * 1000) {
  const isActive = ref(false)
  const timer = ref(null)
  const lastRefreshTime = ref(null)
  
  const startAutoRefresh = () => {
    if (isActive.value) return
    
    isActive.value = true
    timer.value = setInterval(() => {
      // 只在页面可见时执行刷新
      if (!document.hidden) {
        callback()
        lastRefreshTime.value = new Date()
      }
    }, interval)
  }
  
  const stopAutoRefresh = () => {
    if (timer.value) {
      clearInterval(timer.value)
      timer.value = null
    }
    isActive.value = false
  }
  
  const forceRefresh = () => {
    callback()
    lastRefreshTime.value = new Date()
  }
  
  // 页面可见性变化处理
  const handleVisibilityChange = () => {
    if (document.hidden) {
      // 页面隐藏时停止刷新
      stopAutoRefresh()
    } else if (isActive.value) {
      // 页面重新可见时恢复刷新
      startAutoRefresh()
    }
  }
  
  // 添加页面可见性监听
  document.addEventListener('visibilitychange', handleVisibilityChange)
  
  // 清理
  onUnmounted(() => {
    stopAutoRefresh()
    document.removeEventListener('visibilitychange', handleVisibilityChange)
  })
  
  return {
    isActive,
    lastRefreshTime,
    startAutoRefresh,
    stopAutoRefresh,
    forceRefresh
  }
}
```

### 状态管理扩展
根据 [Source: architecture/10.frontend-architecture.md#状态管理]：

**Certificate Store 仪表板功能扩展：**
```javascript
// stores/modules/certificate.js
export const useCertificateStore = defineStore('certificate', {
  state: () => ({
    // 现有状态...
    certificates: [],
    currentCertificate: null,
    loading: false,
    
    // 新增仪表板相关状态
    dashboardStats: {
      total: 0,
      normal: 0,
      expiring: 0,
      expired: 0
    },
    expiringCertificates: [],
    recentCertificates: [],
    statsLoading: false
  }),

  getters: {
    // 现有getters...
    
    // 仪表板相关getters
    totalCertificates: (state) => state.dashboardStats.total,
    
    normalPercentage: (state) => {
      const total = state.dashboardStats.total
      return total > 0 ? Math.round((state.dashboardStats.normal / total) * 100) : 0
    },
    
    criticalCertificatesCount: (state) => {
      return state.dashboardStats.expiring + state.dashboardStats.expired
    },
    
    hasExpiringCertificates: (state) => state.expiringCertificates.length > 0
  },

  actions: {
    // 现有方法...
    
    // 仪表板相关方法
    async fetchDashboardStats() {
      this.statsLoading = true
      
      try {
        const response = await getDashboardStats()
        this.dashboardStats = response.data
      } catch (error) {
        console.error('获取仪表板统计失败:', error)
        throw error
      } finally {
        this.statsLoading = false
      }
    },
    
    async fetchExpiringCertificates(days = 7) {
      this.loading = true
      
      try {
        const response = await getExpiringCertificates(days)
        this.expiringCertificates = response.data
      } catch (error) {
        console.error('获取即将过期证书失败:', error)
        throw error
      } finally {
        this.loading = false
      }
    },
    
    async fetchRecentCertificates(limit = 5) {
      this.loading = true
      
      try {
        const response = await getRecentCertificates(limit)
        this.recentCertificates = response.data
      } catch (error) {
        console.error('获取最近证书失败:', error)
        throw error
      } finally {
        this.loading = false
      }
    }
  }
})
```

### API 接口规范
根据 [Source: architecture/5.api-specs.md]：

**仪表板相关API设计：**
```javascript
// api/certificate.js
/**
 * 获取仪表板统计信息
 * @returns {Promise} API响应
 */
export function getDashboardStats() {
  return api.get('/api/v1/certificates/dashboard/stats')
}

/**
 * 获取即将过期的证书
 * @param {number} days 天数阈值
 * @returns {Promise} API响应
 */
export function getExpiringCertificates(days = 7) {
  return api.get('/api/v1/certificates/expiring', {
    params: { days }
  })
}

/**
 * 获取最近添加的证书
 * @param {number} limit 数量限制
 * @returns {Promise} API响应
 */
export function getRecentCertificates(limit = 5) {
  return api.get('/api/v1/certificates/recent', {
    params: { limit }
  })
}
```

**API端点详情：**
- **仪表板统计**：`GET /api/v1/certificates/dashboard/stats` - 返回证书总数和状态分布
- **即将过期证书**：`GET /api/v1/certificates/expiring?days=7` - 返回指定天数内到期的证书列表
- **最近证书**：`GET /api/v1/certificates/recent?limit=5` - 返回最近添加的证书列表
- **响应时间要求**：< 2秒
- **缓存策略**：前端缓存5分钟，避免频繁API调用

### 数据模型
根据 [Source: architecture/4.data-models.md]：

**DashboardStats 接口（新增）：**
```typescript
interface DashboardStats {
  total: number;        // 证书总数
  normal: number;       // 正常状态证书数
  expiring: number;     // 即将过期证书数
  expired: number;      // 已过期证书数
  lastUpdated: Date;    // 最后更新时间
}
```

**Certificate 接口（已存在，用于列表展示）：**
```typescript
interface Certificate {
  id: number;
  name: string;         // 证书名称
  domain: string;       // 域名
  issuer: string;       // 颁发机构
  issueDate: Date;      // 颁发日期
  expiryDate: Date;     // 到期日期
  certificateType: string;
  status: 'NORMAL' | 'EXPIRING_SOON' | 'EXPIRED';
  createdAt: Date;      // 创建时间（用于最近证书排序）
  updatedAt: Date;
}
```

### 编码规范
根据 [Source: architecture/17.coding-standards.md]：

**关键规则：**
- 组件名称：PascalCase (`Dashboard.vue`, `CertificateStatsCard.vue`)
- 方法/变量：camelCase (`dashboardStats`, `fetchDashboardData`)
- API调用：通过服务层，不直接使用HTTP客户端
- 状态管理：通过Pinia store，不直接变更状态
- 数据验证：所有API响应数据必须验证
- 错误处理：统一错误处理和用户反馈
- 性能优化：使用自动刷新和缓存机制避免频繁API调用

### 响应式设计
根据 [Source: architecture/10.frontend-architecture.md#样式设计]：

**仪表板响应式要求：**
```scss
// 仪表板样式设计
.dashboard {
  padding: 20px;
  
  @include respond-to('sm') {
    padding: 10px;
  }
  
  .stats-row {
    margin-bottom: 20px;
    
    .el-col {
      margin-bottom: 16px;
      
      @include respond-to('md') {
        margin-bottom: 0;
      }
    }
  }
  
  .content-row {
    .el-card {
      height: 400px;
      
      @include respond-to('sm') {
        height: auto;
        margin-bottom: 16px;
      }
    }
  }
}
```

### Testing
根据 [Source: architecture/16.testing-strategy.md#前端测试]：

**测试标准：**
- 使用 Vitest 作为测试框架
- 使用 Vue Test Utils 进行组件测试
- 测试文件位置：`frontend/tests/unit/views/monitoring/`
- 测试命名：`Dashboard.spec.js`
- 覆盖率目标：仪表板功能和组件逻辑 80%+

**测试示例：**
```javascript
// tests/unit/views/monitoring/Dashboard.spec.js
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { mount } from '@vue/test-utils'
import { createPinia, setActivePinia } from 'pinia'
import Dashboard from '@/views/monitoring/Dashboard.vue'
import { useCertificateStore } from '@/stores/modules/certificate'

describe('Dashboard.vue', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  it('should render dashboard statistics correctly', async () => {
    const wrapper = mount(Dashboard)
    const store = useCertificateStore()
    
    // 模拟统计数据
    store.dashboardStats = {
      total: 10,
      normal: 7,
      expiring: 2,
      expired: 1
    }
    
    await wrapper.vm.$nextTick()
    
    expect(wrapper.find('.total-count .count-number').text()).toBe('10')
    expect(wrapper.find('.status-normal .status-count').text()).toBe('7')
    expect(wrapper.find('.status-expiring .status-count').text()).toBe('2')
    expect(wrapper.find('.status-expired .status-count').text()).toBe('1')
  })

  it('should auto refresh data every 5 minutes', async () => {
    vi.useFakeTimers()
    
    const wrapper = mount(Dashboard)
    const store = useCertificateStore()
    const fetchSpy = vi.spyOn(store, 'fetchDashboardStats')
    
    // 初始调用
    expect(fetchSpy).toHaveBeenCalledTimes(1)
    
    // 5分钟后自动刷新
    vi.advanceTimersByTime(5 * 60 * 1000)
    
    expect(fetchSpy).toHaveBeenCalledTimes(2)
    
    vi.useRealTimers()
  })

  it('should handle manual refresh correctly', async () => {
    const wrapper = mount(Dashboard)
    const store = useCertificateStore()
    const fetchSpy = vi.spyOn(store, 'fetchDashboardStats')
    
    const refreshButton = wrapper.find('[data-testid="refresh-button"]')
    await refreshButton.trigger('click')
    
    expect(fetchSpy).toHaveBeenCalled()
  })
})
```

**运行测试命令：**
```bash
cd frontend
npm run test -- Dashboard.spec.js
npm run test:coverage # 运行覆盖率测试
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-17 | 1.0 | 初始故事创建 | Bob (Scrum Master) |