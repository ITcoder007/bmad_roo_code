# Story 3.2: 证书详情页基础功能

## Status
Draft

## Story
**As a** 前端开发人员,
**I want** 实现证书详情页的基础信息展示,
**so that** 用户能够查看证书的完整信息.

## Acceptance Criteria
1. 实现证书详情页面，展示所有证书元数据
2. 添加证书状态的可视化展示，包括状态图标和颜色标识
3. 实现证书信息的编辑功能，支持修改证书元数据
4. 实现证书删除功能，包括确认对话框
5. 添加返回列表的导航按钮
6. 确保详情页在桌面浏览器上的基本响应式布局
7. 添加表单验证和错误提示

## Tasks / Subtasks

- [ ] Task 1: 创建证书详情页面基础结构 (AC: 1, 6)
  - [ ] Subtask 1.1: 在 `/frontend/src/views/certificate/CertificateDetail.vue` 中实现证书详情页面
  - [ ] Subtask 1.2: 使用 Element Plus Card 组件展示证书信息
  - [ ] Subtask 1.3: 配置响应式布局，适配桌面浏览器
  - [ ] Subtask 1.4: 集成路由参数获取证书ID

- [ ] Task 2: 实现证书状态可视化展示 (AC: 2)
  - [ ] Subtask 2.1: 添加状态图标组件，使用 Element Plus 图标
  - [ ] Subtask 2.2: 实现状态颜色标识（正常-绿色、即将过期-橙色、已过期-红色）
  - [ ] Subtask 2.3: 添加状态描述文本，包含到期天数信息
  - [ ] Subtask 2.4: 实现状态徽章样式

- [ ] Task 3: 集成证书数据获取和状态管理 (AC: 1)
  - [ ] Subtask 3.1: 在 `certificate.js` store 中添加 `fetchCertificateDetail` action
  - [ ] Subtask 3.2: 在 `/frontend/src/api/certificate.js` 中实现 `getCertificateDetail` API 调用
  - [ ] Subtask 3.3: 在详情页面中集成 Pinia store 获取证书数据
  - [ ] Subtask 3.4: 添加 Loading 状态处理和错误处理

- [ ] Task 4: 实现证书信息编辑功能 (AC: 3, 7)
  - [ ] Subtask 4.1: 添加编辑模式切换功能
  - [ ] Subtask 4.2: 使用 Element Plus Form 组件创建编辑表单
  - [ ] Subtask 4.3: 实现表单验证，包含必填字段和格式验证
  - [ ] Subtask 4.4: 集成 `updateCertificate` API 调用和 store action

- [ ] Task 5: 实现证书删除功能 (AC: 4)
  - [ ] Subtask 5.1: 添加删除按钮，使用危险样式
  - [ ] Subtask 5.2: 实现删除确认对话框，使用 Element Plus MessageBox
  - [ ] Subtask 5.3: 集成 `deleteCertificate` API 调用
  - [ ] Subtask 5.4: 删除成功后自动跳转到证书列表

- [ ] Task 6: 添加导航和交互功能 (AC: 5)
  - [ ] Subtask 6.1: 添加返回列表按钮
  - [ ] Subtask 6.2: 实现面包屑导航
  - [ ] Subtask 6.3: 添加页面标题和页面描述
  - [ ] Subtask 6.4: 实现浏览器后退按钮支持

- [ ] Task 7: 编写单元测试和组件测试 (AC: 1-7)
  - [ ] Subtask 7.1: 创建 `tests/unit/views/certificate/CertificateDetail.spec.js` 测试文件
  - [ ] Subtask 7.2: 编写证书详情页数据渲染的测试用例
  - [ ] Subtask 7.3: 编写状态可视化展示的测试用例
  - [ ] Subtask 7.4: 编写编辑模式切换和表单验证的测试用例
  - [ ] Subtask 7.5: 编写删除功能和确认对话框的测试用例
  - [ ] Subtask 7.6: 编写导航功能的测试用例

## Dev Notes

### 前一个故事的关键信息
基于 [Source: docs/stories/3.1.story.md#Dev Agent Record]：
- 证书列表页面已实现，包含查看详情的导航功能
- BaseTable、BaseDialog、Loading 等通用组件已可用
- 证书状态管理(certificate store)已完善，包含基础的 CRUD 操作
- 路由配置已建立，支持 `/certificates/:id` 详情页面路由

### 技术栈配置
根据 [Source: architecture/3.tech-stack.md]：

**前端技术栈（必须使用）：**
- Vue.js 3.x - 响应式用户界面框架
- Vue Router 4.x - 前端路由管理  
- Pinia 2.x - 状态管理
- Element Plus 2.x - UI 组件库
- Vite 4.x - 构建工具
- JavaScript ES2020+ - 开发语言
- Vitest 1.x + Vue Test Utils 2.x - 测试框架

### 项目结构
根据 [Source: architecture/12.unified-project-structure.md]：

**证书详情页相关文件位置：**
```
frontend/src/
├── views/certificate/
│   ├── CertificateDetail.vue            # 证书详情页面（本故事主要文件）
│   ├── CertificateList.vue              # 证书列表页面（已存在）
│   └── CertificateForm.vue              # 证书表单页面（已存在）
├── components/
│   ├── common/
│   │   ├── BaseDialog.vue               # 基础对话框组件（已存在）
│   │   ├── Loading.vue                  # 加载组件（已存在）
│   │   └── BaseForm.vue                 # 基础表单组件（已存在）
│   └── business/
│       └── CertificateStatusBadge.vue   # 证书状态徽章组件（新建）
├── stores/modules/
│   └── certificate.js                   # 证书状态管理（已存在，需扩展）
├── api/
│   └── certificate.js                   # 证书API接口（已存在，需扩展）
└── router/modules/
    └── certificate.js                   # 证书路由模块（已存在）
```

### 前端架构设计
根据 [Source: architecture/10.frontend-architecture.md]：

**Vue 3 组合式API模式：**
```javascript
// CertificateDetail.vue 组件结构示例
<template>
  <div class="certificate-detail">
    <!-- 页面标题和导航 -->
    <div class="page-header">
      <el-breadcrumb>
        <el-breadcrumb-item to="/certificates">证书列表</el-breadcrumb-item>
        <el-breadcrumb-item>证书详情</el-breadcrumb-item>
      </el-breadcrumb>
      <h1>{{ certificate?.name || '证书详情' }}</h1>
    </div>
    
    <!-- 加载状态 -->
    <Loading v-if="loading" />
    
    <!-- 证书详情内容 -->
    <div v-else-if="certificate" class="detail-content">
      <!-- 证书状态展示 -->
      <el-card class="status-card">
        <CertificateStatusBadge :status="certificate.status" :expiry-date="certificate.expiryDate" />
      </el-card>
      
      <!-- 编辑模式/查看模式 -->
      <el-card class="info-card">
        <template #header>
          <div class="card-header">
            <span>证书信息</span>
            <div class="card-actions">
              <el-button v-if="!editMode" @click="toggleEditMode">编辑</el-button>
              <el-button v-else @click="cancelEdit">取消</el-button>
              <el-button v-if="editMode" type="primary" @click="saveChanges">保存</el-button>
            </div>
          </div>
        </template>
        
        <!-- 查看模式 -->
        <div v-if="!editMode" class="view-mode">
          <el-descriptions :column="2" border>
            <el-descriptions-item label="证书名称">{{ certificate.name }}</el-descriptions-item>
            <el-descriptions-item label="域名">{{ certificate.domain }}</el-descriptions-item>
            <el-descriptions-item label="颁发机构">{{ certificate.issuer }}</el-descriptions-item>
            <el-descriptions-item label="证书类型">{{ certificate.certificateType }}</el-descriptions-item>
            <el-descriptions-item label="颁发日期">{{ formatDate(certificate.issueDate) }}</el-descriptions-item>
            <el-descriptions-item label="到期日期">{{ formatDate(certificate.expiryDate) }}</el-descriptions-item>
            <el-descriptions-item label="创建时间">{{ formatDate(certificate.createdAt) }}</el-descriptions-item>
            <el-descriptions-item label="更新时间">{{ formatDate(certificate.updatedAt) }}</el-descriptions-item>
          </el-descriptions>
        </div>
        
        <!-- 编辑模式 -->
        <el-form v-else ref="formRef" :model="editForm" :rules="formRules" label-width="120px">
          <el-form-item label="证书名称" prop="name">
            <el-input v-model="editForm.name" />
          </el-form-item>
          <el-form-item label="域名" prop="domain">
            <el-input v-model="editForm.domain" />
          </el-form-item>
          <el-form-item label="颁发机构" prop="issuer">
            <el-input v-model="editForm.issuer" />
          </el-form-item>
          <el-form-item label="证书类型" prop="certificateType">
            <el-select v-model="editForm.certificateType" placeholder="请选择证书类型">
              <el-option label="SSL/TLS" value="SSL/TLS" />
              <el-option label="代码签名" value="CODE_SIGNING" />
              <el-option label="邮件加密" value="EMAIL" />
            </el-select>
          </el-form-item>
          <el-form-item label="颁发日期" prop="issueDate">
            <el-date-picker v-model="editForm.issueDate" type="date" value-format="YYYY-MM-DD" />
          </el-form-item>
          <el-form-item label="到期日期" prop="expiryDate">
            <el-date-picker v-model="editForm.expiryDate" type="date" value-format="YYYY-MM-DD" />
          </el-form-item>
        </el-form>
      </el-card>
      
      <!-- 操作按钮 -->
      <div class="action-buttons">
        <el-button @click="goBack">返回列表</el-button>
        <el-button type="danger" @click="handleDelete">删除证书</el-button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { useCertificateStore } from '@/stores/modules/certificate'
import { ElMessage, ElMessageBox } from 'element-plus'
import CertificateStatusBadge from '@/components/business/CertificateStatusBadge.vue'
import Loading from '@/components/common/Loading.vue'
import { formatDate } from '@/utils/date'

const route = useRoute()
const router = useRouter()
const certificateStore = useCertificateStore()

// 响应式数据
const loading = ref(false)
const editMode = ref(false)
const formRef = ref(null)
const editForm = ref({})

// 计算属性
const certificate = computed(() => certificateStore.currentCertificate)

// 表单验证规则
const formRules = {
  name: [
    { required: true, message: '请输入证书名称', trigger: 'blur' },
    { min: 2, max: 100, message: '证书名称长度在 2 到 100 个字符', trigger: 'blur' }
  ],
  domain: [
    { required: true, message: '请输入域名', trigger: 'blur' },
    { pattern: /^[a-zA-Z0-9]([a-zA-Z0-9\-]*[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9\-]*[a-zA-Z0-9])?)*$/, message: '请输入有效的域名', trigger: 'blur' }
  ],
  issuer: [
    { required: true, message: '请输入颁发机构', trigger: 'blur' }
  ],
  certificateType: [
    { required: true, message: '请选择证书类型', trigger: 'change' }
  ],
  issueDate: [
    { required: true, message: '请选择颁发日期', trigger: 'change' }
  ],
  expiryDate: [
    { required: true, message: '请选择到期日期', trigger: 'change' }
  ]
}

// 方法
const loadCertificate = async () => {
  loading.value = true
  try {
    const certificateId = route.params.id
    await certificateStore.fetchCertificateDetail(certificateId)
  } catch (error) {
    ElMessage.error('获取证书详情失败')
    router.push('/certificates')
  } finally {
    loading.value = false
  }
}

const toggleEditMode = () => {
  editMode.value = true
  editForm.value = { ...certificate.value }
}

const cancelEdit = () => {
  editMode.value = false
  editForm.value = {}
}

const saveChanges = async () => {
  try {
    await formRef.value.validate()
    await certificateStore.updateCertificate(certificate.value.id, editForm.value)
    editMode.value = false
    ElMessage.success('证书信息更新成功')
  } catch (error) {
    ElMessage.error('证书信息更新失败')
  }
}

const handleDelete = async () => {
  try {
    await ElMessageBox.confirm('确认删除此证书？删除后无法恢复。', '警告', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning'
    })
    
    await certificateStore.deleteCertificate(certificate.value.id)
    ElMessage.success('证书删除成功')
    router.push('/certificates')
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('证书删除失败')
    }
  }
}

const goBack = () => {
  router.push('/certificates')
}

// 生命周期
onMounted(() => {
  loadCertificate()
})
</script>

<style scoped>
.certificate-detail {
  padding: 20px;
}

.page-header {
  margin-bottom: 20px;
}

.detail-content .el-card {
  margin-bottom: 20px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.action-buttons {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
}
</style>
```

### 状态管理扩展
根据 [Source: architecture/10.frontend-architecture.md#状态管理]：

**Certificate Store 扩展：**
```javascript
// stores/modules/certificate.js
export const useCertificateStore = defineStore('certificate', {
  state: () => ({
    // 现有状态...
    currentCertificate: null,
    loading: false
  }),

  actions: {
    // 现有方法...
    
    async fetchCertificateDetail(id) {
      this.loading = true
      try {
        const response = await getCertificateDetail(id)
        this.currentCertificate = response.data
      } catch (error) {
        console.error('获取证书详情失败:', error)
        throw error
      } finally {
        this.loading = false
      }
    },

    async updateCertificate(id, data) {
      try {
        const response = await updateCertificate(id, data)
        this.currentCertificate = response.data
        // 同时更新列表中的证书
        const index = this.certificates.findIndex(cert => cert.id === id)
        if (index !== -1) {
          this.certificates[index] = response.data
        }
      } catch (error) {
        console.error('更新证书失败:', error)
        throw error
      }
    }
  }
})
```

### API 接口规范
根据 [Source: architecture/5.api-specs.md]：

**证书详情API：**
```javascript
// api/certificate.js
/**
 * 获取证书详情
 * @param {number} id 证书ID
 * @returns {Promise} API响应
 */
export function getCertificateDetail(id) {
  return api.get(`/api/v1/certificates/${id}`)
}

/**
 * 更新证书
 * @param {number} id 证书ID
 * @param {Object} data 证书数据
 * @returns {Promise} API响应
 */
export function updateCertificate(id, data) {
  return api.put(`/api/v1/certificates/${id}`, data)
}
```

### 路由配置
根据 [Source: architecture/10.frontend-architecture.md#路由设计]：

**证书详情路由：**
```javascript
// router/modules/certificate.js
{
  path: '/certificates/:id',
  name: 'CertificateDetail',
  component: () => import('@/views/certificate/CertificateDetail.vue'),
  meta: { 
    title: '证书详情', 
    hidden: true,
    requiresAuth: true 
  }
}
```

### 响应式布局设计
根据 [Source: architecture/10.frontend-architecture.md#样式设计]：

**响应式设计要求：**
```scss
// 证书详情页样式
.certificate-detail {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  
  @include respond-to('sm') {
    padding: 10px;
  }
  
  .detail-content {
    .el-card {
      margin-bottom: 20px;
      
      @include respond-to('sm') {
        margin-bottom: 15px;
      }
    }
  }
  
  .action-buttons {
    @include respond-to('sm') {
      flex-direction: column;
      
      .el-button {
        width: 100%;
        margin-bottom: 10px;
      }
    }
  }
}
```

### 数据模型
根据 [Source: architecture/4.data-models.md]：

**Certificate 接口：**
```typescript
interface Certificate {
  id: number;
  name: string;
  domain: string;
  issuer: string;
  issueDate: Date;
  expiryDate: Date;
  certificateType: string;
  status: 'NORMAL' | 'EXPIRING_SOON' | 'EXPIRED';
  createdAt: Date;
  updatedAt: Date;
}
```

### 编码规范
根据 [Source: architecture/17.coding-standards.md]：

**关键规则：**
- 组件名称：PascalCase (`CertificateDetail.vue`)
- 方法/变量：camelCase (`loadCertificate`, `toggleEditMode`)
- API调用：通过服务层，不直接使用HTTP客户端
- 状态管理：通过Pinia store，不直接变更状态
- 表单验证：所有用户输入必须验证
- 日期处理：使用UTC时间存储，本地时间显示
- 错误处理：统一错误处理和用户反馈

## Testing
根据 [Source: architecture/16.testing-strategy.md#前端测试]：

**测试标准：**
- 使用 Vitest 作为测试框架
- 使用 Vue Test Utils 进行组件测试
- 测试文件位置：`frontend/tests/unit/`
- 测试命名：`CertificateDetail.spec.js`
- 覆盖率目标：组件逻辑和交互 80%+

**测试示例：**
```javascript
// tests/unit/views/certificate/CertificateDetail.spec.js
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { mount } from '@vue/test-utils'
import { createPinia, setActivePinia } from 'pinia'
import { createRouter, createWebHistory } from 'vue-router'
import CertificateDetail from '@/views/certificate/CertificateDetail.vue'
import { useCertificateStore } from '@/stores/modules/certificate'

const router = createRouter({
  history: createWebHistory(),
  routes: [
    { path: '/certificates/:id', component: CertificateDetail }
  ]
})

describe('CertificateDetail.vue', () => {
  beforeEach(() => {
    setActivePinia(createPinia())
  })

  it('should render certificate details correctly when data is loaded', async () => {
    const mockCertificate = {
      id: 1,
      name: '测试证书',
      domain: 'test.example.com',
      issuer: '测试CA',
      status: 'NORMAL',
      expiryDate: '2024-12-31'
    }
    
    router.push('/certificates/1')
    await router.isReady()
    
    const wrapper = mount(CertificateDetail, {
      global: {
        plugins: [router]
      }
    })
    
    const certificateStore = useCertificateStore()
    certificateStore.currentCertificate = mockCertificate
    
    await wrapper.vm.$nextTick()
    
    expect(wrapper.text()).toContain('测试证书')
    expect(wrapper.text()).toContain('test.example.com')
  })

  it('should toggle edit mode when edit button clicked', async () => {
    const wrapper = mount(CertificateDetail, {
      global: {
        plugins: [router]
      }
    })
    
    const editButton = wrapper.find('[data-testid="edit-button"]')
    await editButton.trigger('click')
    
    expect(wrapper.vm.editMode).toBe(true)
    expect(wrapper.find('el-form').exists()).toBe(true)
  })

  it('should show delete confirmation dialog when delete button clicked', async () => {
    const mockConfirm = vi.fn().mockResolvedValue(true)
    vi.mock('element-plus', () => ({
      ElMessageBox: {
        confirm: mockConfirm
      }
    }))

    const wrapper = mount(CertificateDetail, {
      global: {
        plugins: [router]
      }
    })
    
    const deleteButton = wrapper.find('[data-testid="delete-button"]')
    await deleteButton.trigger('click')
    
    expect(mockConfirm).toHaveBeenCalledWith(
      expect.stringContaining('确认删除'),
      '警告',
      expect.any(Object)
    )
  })
})
```

**运行测试命令：**
```bash
cd frontend
npm run test -- CertificateDetail.spec.js
npm run test:coverage # 运行覆盖率测试
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-17 | 1.0 | 初始故事创建 | Bob (Scrum Master) |