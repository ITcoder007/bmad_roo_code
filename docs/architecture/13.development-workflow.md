# 开发工作流

## 概述

证书生命周期管理系统的开发工作流定义了从环境设置到代码部署的完整流程。本节详细说明了开发环境的配置、开发命令的使用以及环境变量的管理，确保开发团队能够高效协作。

## 本地开发设置

### 前置条件

在开始开发之前，请确保您的开发环境满足以下要求：

#### 系统要求

- **操作系统**: Windows 10+, macOS 10.14+, 或 Linux (Ubuntu 18.04+)
- **内存**: 最少 8GB RAM，推荐 16GB
- **存储**: 最少 10GB 可用空间

#### 软件要求

- **Node.js**: 版本 16.x 或更高
- **npm**: 版本 8.x 或更高
- **Java Development Kit (JDK)**: 版本 8
- **Apache Maven**: 版本 3.8.x 或更高
- **Git**: 版本 2.x 或更高
- **Docker**: 版本 20.x 或更高（可选，用于容器化部署）
- **MySQL**: 版本 8.0 或更高（可选，可使用 Docker 容器）

#### 开发工具（推荐）

- **前端开发**: Visual Studio Code
  - 插件推荐: Volar, ESLint, Prettier, GitLens
- **后端开发**: IntelliJ IDEA 或 Eclipse
  - 插件推荐: Lombok, Spring Assistant, Maven Helper

### 初始设置

1. **克隆仓库**

   ```bash
   # 克隆仓库
   git clone <repository-url>
   cd certificate-lifecycle-management
   ```

2. **安装前端依赖**

   ```bash
   # 进入前端目录
   cd frontend
   
   # 安装依赖
   npm install
   
   # 返回根目录
   cd ..
   ```

3. **设置后端依赖**

   ```bash
   # 进入后端目录
   cd backend
   
   # 安装依赖并构建项目
   mvn clean install
   
   # 返回根目录
   cd ..
   ```

4. **配置数据库**

   选项 1: 使用本地 MySQL 安装

   ```sql
   -- 创建数据库
   CREATE DATABASE certificate_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
   
   -- 创建用户（可选）
   CREATE USER 'certificate_user'@'localhost' IDENTIFIED BY 'certificate_password';
   
   -- 授予权限
   GRANT ALL PRIVILEGES ON certificate_management.* TO 'certificate_user'@'localhost';
   
   -- 刷新权限
   FLUSH PRIVILEGES;
   ```

   选项 2: 使用 Docker 容器

   ```bash
   # 启动 MySQL 容器
   docker run -d --name certificate-mysql \
     -e MYSQL_ROOT_PASSWORD=rootpassword \
     -e MYSQL_DATABASE=certificate_management \
     -e MYSQL_USER=certificate_user \
     -e MYSQL_PASSWORD=certificate_password \
     -p 3306:3306 \
     mysql:8.0
   ```

5. **配置环境变量**

   ```bash
   # 复制环境变量模板
   cp .env.example .env
   
   # 编辑环境变量文件，根据实际情况修改配置
   # 例如数据库连接、API密钥等
   ```

### 开发命令

#### 同时启动前端和后端

```bash
# 在项目根目录执行
npm run dev
```

这将同时启动前端开发服务器和后端开发服务器。

#### 分别启动前端和后端

1. **启动前端开发服务器**

   ```bash
   # 在项目根目录执行
   npm run dev:web
   
   # 或者在前端目录执行
   cd frontend
   npm run dev
   ```

   前端开发服务器将在 http://localhost:3000 启动（或根据配置的其他端口）。

2. **启动后端开发服务器**

   ```bash
   # 在项目根目录执行
   npm run dev:api
   
   # 或者在后端目录执行
   cd backend
   mvn spring-boot:run
   ```

   后端开发服务器将在 http://localhost:8080 启动（或根据配置的其他端口）。

#### 测试命令

```bash
# 运行前端测试
npm run test:web

# 运行后端测试
npm run test:api

# 运行所有测试
npm run test
```

#### 代码质量检查

```bash
# 检查前端代码风格
npm run lint

# 格式化前端代码
npm run format
```

#### 构建命令

```bash
# 构建前端
npm run build:web

# 构建后端
npm run build:api

# 构建所有应用
npm run build
```

## 环境配置

### 环境变量管理

项目使用环境变量来管理不同环境的配置。环境变量文件位于项目根目录和各应用目录中。

#### 根目录环境变量

`.env` 文件包含项目级别的环境变量：

```bash
# 项目配置
PROJECT_NAME=证书生命周期管理系统
PROJECT_VERSION=1.0.0

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=certificate_management
DB_USER=certificate_user
DB_PASSWORD=certificate_password

# API 配置
API_BASE_URL=http://localhost:8080/api
API_VERSION=v1

# JWT 配置
JWT_SECRET=your-jwt-secret-key
JWT_EXPIRATION=86400 # 24小时，单位秒
```

#### 前端环境变量

前端应用使用以下环境变量文件：

1. `.env` - 默认环境变量
2. `.env.development` - 开发环境变量
3. `.env.production` - 生产环境变量
4. `.env.staging` - 预发布环境变量

示例 `.env.development` 文件：

```bash
# 应用配置
VITE_APP_TITLE=证书生命周期管理系统 (开发)
VITE_APP_VERSION=1.0.0-dev

# API 配置
VITE_API_BASE_URL=http://localhost:8080/api
VITE_API_VERSION=v1

# 功能开关
VITE_ENABLE_DEBUG=true
VITE_ENABLE_MOCK=false
```

示例 `.env.production` 文件：

```bash
# 应用配置
VITE_APP_TITLE=证书生命周期管理系统
VITE_APP_VERSION=1.0.0

# API 配置
VITE_API_BASE_URL=https://api.example.com/api
VITE_API_VERSION=v1

# 功能开关
VITE_ENABLE_DEBUG=false
VITE_ENABLE_MOCK=false
```

#### 后端环境变量

后端应用使用 Spring Boot 的配置文件来管理环境变量：

1. `src/main/resources/application.yml` - 默认配置
2. `src/main/resources/application-dev.yml` - 开发环境配置
3. `src/main/resources/application-prod.yml` - 生产环境配置
4. `src/main/resources/application-test.yml` - 测试环境配置

示例 `application-dev.yml` 文件：

```yaml
server:
  port: 8080
  servlet:
    context-path: /

spring:
  application:
    name: certificate-management-backend
  datasource:
    url: jdbc:mysql://localhost:3306/certificate_management?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: certificate_user
    password: certificate_password
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      minimum-idle: 5
      maximum-pool-size: 15
      idle-timeout: 30000
      pool-name: CertificateHikariCP
      max-lifetime: 1800000
      connection-timeout: 30000
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MySQL8Dialect
  devtools:
    restart:
      enabled: true

# 日志配置
logging:
  level:
    com.example.certificate: DEBUG
    org.springframework.web: INFO
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

# 应用配置
app:
  jwt:
    secret: your-jwt-secret-key
    expiration: 86400000 # 24小时，单位毫秒
  monitoring:
    check-interval: 3600000 # 1小时，单位毫秒
    alert-thresholds:
      - 30
      - 15
      - 7
      - 1
```

示例 `application-prod.yml` 文件：

```yaml
server:
  port: 8080
  servlet:
    context-path: /

spring:
  application:
    name: certificate-management-backend
  datasource:
    url: jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:certificate_management}?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: ${DB_USER:certificate_user}
    password: ${DB_PASSWORD:certificate_password}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      minimum-idle: 10
      maximum-pool-size: 30
      idle-timeout: 60000
      pool-name: CertificateHikariCP
      max-lifetime: 1800000
      connection-timeout: 30000
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQL8Dialect
  devtools:
    restart:
      enabled: false

# 日志配置
logging:
  level:
    com.example.certificate: WARN
    org.springframework.web: WARN
    org.hibernate: WARN
  file:
    name: logs/certificate-management.log
  logback:
    rollingpolicy:
      max-file-size: 10MB
      max-history: 30

# 应用配置
app:
  jwt:
    secret: ${JWT_SECRET:your-production-jwt-secret-key}
    expiration: 86400000 # 24小时，单位毫秒
  monitoring:
    check-interval: 3600000 # 1小时，单位毫秒
    alert-thresholds:
      - 30
      - 15
      - 7
      - 1

# 管理端点配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when-authorized
```

### 数据库迁移

项目使用 Flyway 进行数据库版本管理。数据库迁移脚本位于 `backend/src/main/resources/db/migration/` 目录中。

#### 创建迁移脚本

迁移脚本命名格式为 `V{版本}__{描述}.sql`，例如：

```sql
-- V1__Create_certificate_table.sql
CREATE TABLE certificate (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255) NOT NULL,
  domain VARCHAR(255) NOT NULL,
  issuer VARCHAR(255) NOT NULL,
  expiry_date DATE NOT NULL,
  type VARCHAR(50) NOT NULL,
  status VARCHAR(50) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_domain (domain),
  INDEX idx_expiry_date (expiry_date),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 执行数据库迁移

数据库迁移会在应用启动时自动执行。如果需要手动执行迁移，可以使用以下命令：

```bash
# 在后端目录执行
cd backend

# 使用 Maven 执行迁移
mvn flyway:migrate

# 或者在应用启动时执行
mvn spring-boot:run
```

### 开发工具配置

#### VS Code 配置

创建 `.vscode/settings.json` 文件：

```json
{
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "eslint.validate": [
    "javascript",
    "javascriptreact",
    "vue",
    "typescript",
    "typescriptreact"
  ],
  "vue.codeActions.enabled": true,
  "vue.complete.casing.tags": "pascal",
  "vue.complete.casing.props": "camelCase",
  "files.associations": {
    "*.vue": "vue"
  },
  "search.exclude": {
    "**/node_modules": true,
    "**/dist": true,
    "**/target": true
  }
}
```

创建 `.vscode/extensions.json` 文件：

```json
{
  "recommendations": [
    "vue.volar",
    "esbenp.prettier-vscode",
    "dbaeumer.vscode-eslint",
    "ms-vscode.vscode-typescript-next",
    "editorconfig.editorconfig",
    "eamodio.gitlens"
  ]
}
```

#### IntelliJ IDEA 配置

1. **安装 Lombok 插件**
   - 打开 Settings/Preferences
   - 导航到 Plugins
   - 搜索 Lombok 并安装
   - 重启 IDE

2. **配置注解处理器**
   - 打开 Settings/Preferences
   - 导航到 Build, Execution, Deployment > Compiler > Annotation Processors
   - 勾选 Enable annotation processing

3. **配置代码样式**
   - 打开 Settings/Preferences
   - 导航到 Editor > Code Style
   - 导入项目中的代码样式配置

### Git 工作流

#### 分支策略

项目使用 Git Flow 分支策略：

- `main` - 主分支，用于生产环境
- `develop` - 开发分支，用于集成开发功能
- `feature/*` - 功能分支，用于开发新功能
- `hotfix/*` - 修复分支，用于紧急修复生产问题
- `release/*` - 发布分支，用于准备新版本发布

#### 提交规范

项目使用 Conventional Commits 规范进行提交：

```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

类型（type）可以是：
- `feat`: 新功能
- `fix`: 修复
- `docs`: 文档更改
- `style`: 代码格式（不影响代码运行的变动）
- `refactor`: 重构（既不是新增功能，也不是修改bug的代码变动）
- `perf`: 性能优化
- `test`: 增加测试
- `chore`: 构建过程或辅助工具的变动

示例：

```
feat(certificate): add certificate status calculation

Implement certificate status calculation logic based on expiry date.
The status can be VALID, EXPIRING_SOON, or EXPIRED.

Closes #123
```

#### 代码审查流程

1. 创建功能分支
   ```bash
   git checkout -b feature/certificate-status develop
   ```

2. 开发并提交更改
   ```bash
   git add .
   git commit -m "feat(certificate): add certificate status calculation"
   ```

3. 推送分支到远程仓库
   ```bash
   git push origin feature/certificate-status
   ```

4. 创建 Pull Request
   - 在 GitHub/GitLab 上创建从功能分支到 `develop` 分支的 Pull Request
   - 填写 PR 描述，包括更改内容、测试情况等
   - 指定审查者

5. 代码审查和修改
   - 审查者审查代码并提供反馈
   - 开发者根据反馈修改代码
   - 重复此过程直到代码被批准

6. 合并分支
   - 代码被批准后，将功能分支合并到 `develop` 分支
   - 删除功能分支

### 调试和故障排除

#### 前端调试

1. **浏览器开发者工具**
   - 使用 Chrome DevTools 或 Firefox Developer Tools
   - 查看 Console 输出、Network 请求、Application 状态等

2. **Vue Devtools**
   - 安装 Vue Devtools 浏览器扩展
   - 检查组件状态、Vuex/Pinia 状态、事件等

3. **Vite 开发服务器调试**
   - Vite 提供了热模块替换（HMR）功能
   - 修改代码后，浏览器会自动更新，无需刷新页面

#### 后端调试

1. **IDE 调试**
   - 在 IntelliJ IDEA 中设置断点
   - 使用 Debug 模式启动应用
   - 单步执行代码，检查变量值

2. **日志调试**
   - 使用 SLF4J 和 Logback 记录日志
   - 在 `application-*.yml` 中配置日志级别
   - 查看日志文件或控制台输出

3. **Spring Boot Actuator**
   - 使用 Actuator 端点检查应用状态
   - 访问 `/actuator/health` 检查健康状态
   - 访问 `/actuator/info` 查看应用信息

#### 常见问题及解决方案

1. **前端启动失败**
   - 检查 Node.js 和 npm 版本是否符合要求
   - 删除 `node_modules` 目录并重新运行 `npm install`
   - 检查端口是否被占用

2. **后端启动失败**
   - 检查 JDK 版本是否符合要求
   - 检查数据库连接是否正常
   - 查看错误日志，根据错误信息排查问题

3. **数据库连接失败**
   - 检查 MySQL 服务是否启动
   - 检查数据库用户名和密码是否正确
   - 检查防火墙设置

4. **API 请求失败**
   - 检查后端服务是否正常启动
   - 检查 API 路径是否正确
   - 检查 CORS 配置是否允许前端请求

### 开发最佳实践

#### 前端开发最佳实践

1. **组件设计**
   - 遵循单一职责原则，每个组件只负责一个功能
   - 使用组合而非继承，提高组件复用性
   - 保持组件纯净，避免副作用

2. **状态管理**
   - 使用 Pinia 进行全局状态管理
   - 将状态保存在最接近使用它的组件中
   - 避免不必要的状态提升

3. **性能优化**
   - 使用懒加载和代码分割减少初始加载时间
   - 使用虚拟滚动处理大量数据
   - 避免不必要的重新渲染

4. **代码质量**
   - 使用 ESLint 和 Prettier 保持代码风格一致
   - 编写单元测试和端到端测试
   - 使用 TypeScript 提高代码可维护性

#### 后端开发最佳实践

1. **分层架构**
   - 严格遵循分层架构，避免跨层调用
   - 使用依赖注入降低组件间耦合
   - 在领域层实现核心业务逻辑

2. **数据访问**
   - 使用 MyBatis Plus 进行数据库操作
   - 避免在业务逻辑中直接编写 SQL
   - 使用事务确保数据一致性

3. **异常处理**
   - 使用全局异常处理器统一处理异常
   - 定义清晰的异常类型和错误码
   - 记录详细的错误日志

4. **安全性**
   - 使用 Spring Security 进行认证和授权
   - 对敏感数据进行加密存储
   - 防止 SQL 注入和 XSS 攻击

#### 团队协作最佳实践

1. **代码审查**
   - 所有代码变更必须经过审查
   - 提供具体、建设性的反馈
   - 确保代码符合项目标准

2. **文档维护**
   - 及时更新技术文档和用户文档
   - 为复杂功能添加注释和说明
   - 使用 API 文档工具自动生成文档

3. **持续集成**
   - 使用 CI/CD 流水线自动化构建和测试
   - 确保代码变更不会破坏现有功能
   - 定期部署到测试环境进行验证

4. **知识共享**
   - 定期举行技术分享会议
   - 维护团队知识库
   - 鼓励跨功能学习和合作

这种开发工作流为证书生命周期管理系统提供了清晰的开发指南，确保开发团队能够高效协作，并保持代码质量和项目稳定性。